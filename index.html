<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruokaseuranta</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 750px;
  margin: auto;
  padding: 1rem;
}
.section {
  border: 1px solid #ccc;
  padding: 1rem;
  margin-top: 1rem;
}
.meal-controls, .training-controls {
  display: flex;
  gap: 0.5rem;
}
select, input, button {
  padding: 0.4rem;
}
.meal-controls select {
  flex: 1;
}
.item {
  display: flex;
  justify-content: space-between;
  margin-top: 0.3rem;
}
.locked {
  opacity: 0.6;
  pointer-events: none;
}
.summary-boxes {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.summary-box {
  border: 1px solid #ccc;
  padding: 0.5rem;
  min-width: 90px;
  text-align: center;
}
.summary-box.positive { background:#e6f4ea; color:#1e6b3a; }
.summary-box.negative { background:#fbeaea; color:#8a1f1f; }
.summary-box.zero { background:#eee; color:#333; }
.summary-box.nodata { background:#f5f5f5; color:#777; font-style:italic; }
</style>
</head>

<body>

<h2>Ruokaseuranta</h2>

<label>Päivä</label>
<input type="date" id="date">

<div id="content">

<!-- AAMUPALA -->
<div class="section" id="aamupala">
<h3>Aamupala</h3>
<div class="meal-controls">
<select id="aamupalaSelect"></select>
<input type="number" id="aamupalaGrams" placeholder="g">
<button onclick="addFood('aamupala')">Lisää</button>
</div>
<div class="foods"></div>
</div>

<!-- LOUNAS -->
<div class="section" id="lounas">
<h3>Lounas</h3>
<div class="meal-controls">
<select id="lounasSelect"></select>
<input type="number" id="lounasGrams" placeholder="g">
<button onclick="addFood('lounas')">Lisää</button>
</div>
<div class="foods"></div>
</div>

<!-- VÄLIPALAT -->
<div class="section" id="valipalat">
<h3>Välipalat</h3>
<div class="meal-controls">
<select id="valipalatSelect"></select>
<input type="number" id="valipalatGrams" placeholder="g">
<button onclick="addFood('valipalat')">Lisää</button>
</div>
<div class="foods"></div>
</div>

<!-- ILLALLINEN -->
<div class="section" id="illallinen">
<h3>Illallinen</h3>
<div class="meal-controls">
<select id="illallinenSelect"></select>
<input type="number" id="illallinenGrams" placeholder="g">
<button onclick="addFood('illallinen')">Lisää</button>
</div>
<div class="foods"></div>
</div>

<!-- ILTAPALA -->
<div class="section" id="iltapala">
<h3>Iltapala</h3>
<div class="meal-controls">
<select id="iltapalaSelect"></select>
<input type="number" id="iltapalaGrams" placeholder="g">
<button onclick="addFood('iltapala')">Lisää</button>
</div>
<div class="foods"></div>
</div>

<!-- TREENIT -->
<div class="section">
<h3>Treenit</h3>
<div class="training-controls">
<input id="trainingName" placeholder="Treenin nimi">
<input id="trainingKcal" type="number" placeholder="kcal">
<button onclick="addTraining()">Lisää</button>
</div>
<div id="trainings"></div>
</div>

<button id="saveBtn" onclick="saveDay()">Tallenna päivä</button>

<div class="section">
<h3>Yhteenveto</h3>
<div id="summary"></div>
<div id="fiveDaySummary"></div>
</div>

</div>

<script>
const BMR = 2000;

// Ruoat: kcal / 100g ja oletusgrammat
const foodsDB = {
  // AAMUPALA / VÄLIPALA / ILTAPALA
  appelsiini: { kcal:75, default:100 },
  kauraleipa: { kcal:120, default:100 },
  kaurapuuro_banaani: { kcal:450, default:100 },
  kaurapuuro_piltti: { kcal:383, default:100 },
  mehukeitto: { kcal:44, default:400 },
  ruisleipa: { kcal:96, default:100 },

  // LOUNAS / ILLALLINEN
  gluteeniton_pasta: { kcal:356, default:0 },
  kanakastike_kevyt: { kcal:95, default:0 },
  kanakastike_semi: { kcal:120, default:0 },
  kanakastike_tuhti: { kcal:150, default:0 },
  kanaperuna: { kcal:83, default:0 },
  lasagne: { kcal:120, default:0 },
  peruna: { kcal:75, default:0 },
  perunamuussi: { kcal:120, default:0 },
  tonnikalapihvit: { kcal:170, default:0 },
  täysjyväpasta: { kcal:343, default:0 },
  täysjyväriisi: { kcal:145, default:0 }
};

const mealFoods = {
  aamupala: ["appelsiini","kauraleipa","kaurapuuro_banaani","kaurapuuro_piltti","mehukeitto","ruisleipa"],
  valipalat: ["appelsiini","kauraleipa","kaurapuuro_banaani","kaurapuuro_piltti","mehukeitto","ruisleipa"],
  iltapala: ["appelsiini","kauraleipa","kaurapuuro_banaani","kaurapuuro_piltti","mehukeitto","ruisleipa"],
  lounas: ["gluteeniton_pasta","kanakastike_kevyt","kanakastike_semi","kanakastike_tuhti","kanaperuna","lasagne","peruna","perunamuussi","tonnikalapihvit","täysjyväpasta","täysjyväriisi"],
  illallinen: ["gluteeniton_pasta","kanakastike_kevyt","kanakastike_semi","kanakastike_tuhti","kanaperuna","lasagne","peruna","perunamuussi","tonnikalapihvit","täysjyväpasta","täysjyväriisi"]
};

let dayData, isLocked=false;

function emptyDay(){
  return { foods:{aamupala:[],lounas:[],valipalat:[],illallinen:[],iltapala:[]}, trainings:[] };
}

function fillSelects(){
  for(let meal in mealFoods){
    const sel=document.getElementById(meal+"Select");
    sel.innerHTML='<option value="">Valitse ruoka</option>';
    mealFoods[meal].sort().forEach(f=>{
      sel.innerHTML+=`<option value="${f}">${f.replaceAll("_"," ")}</option>`;
    });
  }
}
fillSelects();

// ============================================
// LISÄTTY: oletusgrammat täyttyvät valinnan yhteydessä
function attachDefaultGrams() {
  const meals = ["aamupala", "lounas", "valipalat", "illallinen", "iltapala"];
  meals.forEach(meal => {
    const select = document.getElementById(meal + "Select");
    const gramsInput = document.getElementById(meal + "Grams");
    select.addEventListener("change", () => {
      if(select.value) {
        gramsInput.value = foodsDB[select.value].default;
      } else {
        gramsInput.value = "";
      }
    });
  });
}
attachDefaultGrams();
// ============================================

function addFood(meal){
  if(isLocked) return;
  const sel=document.getElementById(meal+"Select");
  const gramsInput=document.getElementById(meal+"Grams");
  if(!sel.value) return;
  const grams=Number(gramsInput.value);
  if(isNaN(grams) || grams <= 0) return; // turva
  dayData.foods[meal].push({ id:sel.value, grams });
  gramsInput.value="";
  sel.value="";
  saveDraft(); render();
}

function render(){
  let foodKcal=0;
  for(let meal in dayData.foods){
    const box=document.querySelector(`#${meal} .foods`);
    box.innerHTML="";
    dayData.foods[meal].forEach((f,i)=>{
      const kcal=f.grams*foodsDB[f.id].kcal/100;
      foodKcal+=kcal;
      box.innerHTML+=`<div class="item">${f.id.replaceAll("_"," ")} ${f.grams} g (${Math.round(kcal)} kcal)</div>`;
    });
  }

  let trainKcal=dayData.trainings.reduce((s,t)=>s+t.kcal,0);
  let net=Math.round(foodKcal-(BMR+trainKcal));

  summary.innerHTML=`
  Ruoasta: ${Math.round(foodKcal)} kcal<br>
  Perusaineenvaihdunta: ${BMR} kcal<br>
  Treeneistä: ${trainKcal} kcal<br><br>
  <strong>Netto: ${net} kcal</strong>`;
  renderFiveDaySummary();
}

function renderFiveDaySummary(){
  let html=`<h3>5 päivän koonti</h3><div class="summary-boxes">`, total=0;
  for(let i=1;i<=5;i++){
    const d=new Date(date.value); d.setDate(d.getDate()-i);
    const key=d.toISOString().split("T")[0];
    const stored=localStorage.getItem(key);
    if(stored){
      const data=JSON.parse(stored);
      let fkc=0;
      Object.values(data.foods).flat().forEach(f=>fkc+=f.grams*foodsDB[f.id].kcal/100);
      let tk=data.trainings.reduce((s,t)=>s+t.kcal,0);
      let n=Math.round(fkc-(BMR+tk)); total+=n;
      let cls=n>0?"positive":n<0?"negative":"zero";
      html+=`<div class="summary-box ${cls}"><h4>-${i}</h4>${n} kcal</div>`;
    } else {
      html+=`<div class="summary-box nodata"><h4>-${i}</h4>Ei dataa</div>`;
    }
  }
  html+=`</div><br><strong>Yhteensä: ${total} kcal</strong>`;
  fiveDaySummary.innerHTML=html;
}

function addTraining(){ 
  if(isLocked) return; 
  if(!trainingName.value || !trainingKcal.value) return; 
  dayData.trainings.push({ name: trainingName.value, kcal: Number(trainingKcal.value) });
  trainingName.value=""; trainingKcal.value=""; saveDraft(); render();
}

function saveDraft(){ localStorage.setItem("draft-"+date.value,JSON.stringify(dayData)); }
function saveDay(){ localStorage.setItem(date.value,JSON.stringify(dayData)); lockDay(); }
function lockDay(){ isLocked=true; content.classList.add("locked"); saveBtn.style.display="none"; }

date.addEventListener("change",()=>{
  const f=localStorage.getItem(date.value);
  const d=localStorage.getItem("draft-"+date.value);
  if(f){ dayData=JSON.parse(f); lockDay(); }
  else { isLocked=false; content.classList.remove("locked"); saveBtn.style.display="block"; dayData=d?JSON.parse(d):emptyDay(); }
  render();
});
</script>

</body>
</html>
