<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruokaseuranta</title>

<style>
body { font-family: Arial, sans-serif; max-width: 750px; margin: auto; padding: 1rem; }
.section { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; }
.meal-controls, .training-controls { display: flex; gap: 0.5rem; }
select, input, button { padding: 0.4rem; }
.meal-controls select { flex: 1; }
.item { display: flex; justify-content: space-between; margin-top: 0.3rem; }
.locked { opacity: 0.6; pointer-events: none; }

.summary-boxes { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.summary-box { border: 1px solid #ccc; padding: 0.5rem; min-width: 100px; text-align: center; }
.summary-box.positive { background:#e6f4ea; color:#1e6b3a; }
.summary-box.negative { background:#fbeaea; color:#8a1f1f; }
.summary-box.zero { background:#eee; color:#333; }
.summary-box.nodata { background:#f5f5f5; color:#777; font-style:italic; }

#topButtons { float:right; }
</style>
</head>
<body>

<h2>Ruokaseuranta</h2>
<h4>versio 2.0.4 Tuotanto</h4>

<div id="topButtons">
  <button onclick="downloadCSV()">CSV</button>
  <button onclick="exportJSON()">JSON</button>
  <input type="file" id="jsonImport" accept=".json" onchange="importJSON(event)">
</div>

<label>Päivä</label>
<input type="date" id="date"><br>
<button id="unlockBtn" style="display:none;" onclick="unlockDay()">Muokkaa tietoja</button>

<div id="content">

<!-- ATERIAT -->
<div class="section" id="aamupala"><h3>Aamupala</h3>
<div class="meal-controls">
<select id="aamupalaSelect"></select>
<input type="number" id="aamupalaGrams" placeholder="g">
<button onclick="addFood('aamupala')">Lisää</button>
</div><div class="foods"></div></div>

<div class="section" id="lounas"><h3>Lounas</h3>
<div class="meal-controls">
<select id="lounasSelect"></select>
<input type="number" id="lounasGrams" placeholder="g">
<button onclick="addFood('lounas')">Lisää</button>
</div><div class="foods"></div></div>

<div class="section" id="valipalat"><h3>Välipalat</h3>
<div class="meal-controls">
<select id="valipalatSelect"></select>
<input type="number" id="valipalatGrams" placeholder="g">
<button onclick="addFood('valipalat')">Lisää</button>
</div><div class="foods"></div></div>

<div class="section" id="illallinen"><h3>Illallinen</h3>
<div class="meal-controls">
<select id="illallinenSelect"></select>
<input type="number" id="illallinenGrams" placeholder="g">
<button onclick="addFood('illallinen')">Lisää</button>
</div><div class="foods"></div></div>

<div class="section" id="iltapala"><h3>Iltapala</h3>
<div class="meal-controls">
<select id="iltapalaSelect"></select>
<input type="number" id="iltapalaGrams" placeholder="g">
<button onclick="addFood('iltapala')">Lisää</button>
</div><div class="foods"></div></div>

<!-- TREENIT -->
<div class="section">
<h3>Treenit</h3>
<div class="training-controls">
<input id="trainingName" placeholder="Treenin nimi">
<input id="trainingKcal" type="number" placeholder="kcal">
<button onclick="addTraining()">Lisää</button>
</div>
<div id="trainings"></div>
</div>

<button id="saveBtn" onclick="saveDay()">Tallenna päivä</button>

<div class="section">
<h3>Yhteenveto</h3>
<div id="summary"></div>
<div id="fiveDaySummary"></div>
</div>

</div>

<script>
const BMR = 2000;
const CARB_TARGET = 432;
const FAT_TARGET = 72;

/* ================= RUOKATIETOKANTA ================= */
const foodsDB = {
  // Aamupalat & eväät
  appelsiini: { kcal:75, carbs:12, fat:0, default:100 },
  kauraleipa: { kcal:120, carbs:12.4, fat:5.6, default:100 },
  kaurapuuro_banaani: { kcal:450, carbs:58, fat:5, default:100 },
  kaurapuuro_piltti: { kcal:383, carbs:40, fat:4, default:100 },
  mehukeitto: { kcal:44, carbs:11, fat:0, default:400 },
  ruisleipa: { kcal:96, carbs:8.7, fat:4.6, default:100 },
  kananmuna_paistettu: { kcal:107, carbs:1, fat:16, default:100 },
  mysli: { kcal:340, carbs:62, fat:3.5, default:0 },
  kauragurtti: { kcal:80, carbs:15, fat:1.4, default:0 },

  // Lämpimät ruoat
  gluteeniton_pasta: { kcal:356, carbs:74, fat:2.4, default:0 },
  kanakastike_kevyt: { kcal:95, carbs:4, fat:3, default:0 },
  kanakastike_semi: { kcal:120, carbs:4, fat:5, default:0 },
  kanakastike_tuhti: { kcal:150, carbs:5, fat:9, default:0 },
  kanaperuna: { kcal:83, carbs:7, fat:4, default:0 },
  lasagne: { kcal:120, carbs:8.5, fat:6.5, default:0 },
  peruna: { kcal:75, carbs:16, fat:0.1, default:0 },
  perunamuussi: { kcal:120, carbs:20, fat:3, default:0 },
  tonnikalapihvit: { kcal:170, carbs:4, fat:12, default:0 },
  täysjyväpasta: { kcal:343, carbs:66, fat:2.5, default:0 },
  täysjyväriisi: { kcal:145, carbs:68, fat:0.8, default:0 }
};


const mealFoods = {
  aamupala: [
    "appelsiini",
    "kauraleipa",
    "kaurapuuro_banaani",
    "kaurapuuro_piltti",
    "mehukeitto",
    "ruisleipa",
    "kananmuna_paistettu",
    "mysli",
    "kauragurtti"
  ],
  valipalat: [
    "appelsiini",
    "kauraleipa",
    "kaurapuuro_banaani",
    "kaurapuuro_piltti",
    "mehukeitto",
    "ruisleipa",
    "kananmuna_paistettu",
    "mysli",
    "kauragurtti"
  ],
  iltapala: [
    "appelsiini",
    "kauraleipa",
    "kaurapuuro_banaani",
    "kaurapuuro_piltti",
    "mehukeitto",
    "ruisleipa",
    "kananmuna_paistettu",
    "mysli",
    "kauragurtti"
  ],
  lounas: [
    "gluteeniton_pasta",
    "kanakastike_kevyt",
    "kanakastike_semi",
    "kanakastike_tuhti",
    "kanaperuna",
    "lasagne",
    "peruna",
    "perunamuussi",
    "tonnikalapihvit",
    "täysjyväpasta",
    "täysjyväriisi"
  ],
  illallinen: [
    "gluteeniton_pasta",
    "kanakastike_kevyt",
    "kanakastike_semi",
    "kanakastike_tuhti",
    "kanaperuna",
    "lasagne",
    "peruna",
    "perunamuussi",
    "tonnikalapihvit",
    "täysjyväpasta",
    "täysjyväriisi"
  ]
};

let dayData,isLocked=false;

// Varmistetaan että dayData on aina olemassa
dayData = emptyDay();


function emptyDay(){
  return{foods:{aamupala:[],lounas:[],valipalat:[],illallinen:[],iltapala:[]},trainings:[]};
}

/* ================= UI ================= */
function fillSelects(){
  for(let meal in mealFoods){
    const sel=document.getElementById(meal+"Select");
    sel.innerHTML='<option value="">Valitse ruoka</option>';
    // Sortataan nimet aakkosjärjestykseen
    mealFoods[meal].sort().forEach(f=>{
      // Näytetään nimi ilman alaviivaa
      sel.innerHTML+=`<option value="${f}">${f.replaceAll("_"," ")}</option>`;
    });
  }
}
fillSelects();

function attachDefaultGrams(){
  ["aamupala","lounas","valipalat","illallinen","iltapala"].forEach(meal=>{
    const sel=document.getElementById(meal+"Select");
    const grams=document.getElementById(meal+"Grams");
    sel.addEventListener("change",()=>{
      grams.value=sel.value?foodsDB[sel.value].default:"";
    });
  });
}
attachDefaultGrams();


function ensureDayData(){
  if(!dayData){
    dayData = emptyDay();
  }
}
  

/* ================= LISÄYS / POISTO ================= */
function addFood(meal){
  ensureDayData();
  if(isLocked)return;
  const sel=document.getElementById(meal+"Select");
  const grams=document.getElementById(meal+"Grams");
  if(!sel.value||!grams.value)return;
  dayData.foods[meal].push({id:sel.value,grams:Number(grams.value)});
  sel.value="";grams.value="";
  saveDraft();render();
}
function removeFood(meal,i){
  if(isLocked)return;
  dayData.foods[meal].splice(i,1);
  saveDraft();render();
}

function addTraining(){
  ensureDayData();
  if(isLocked)return;
  if(!trainingName.value||!trainingKcal.value)return;
  dayData.trainings.push({name:trainingName.value,kcal:Number(trainingKcal.value)});
  trainingName.value="";trainingKcal.value="";
  saveDraft();render();
}
function removeTraining(i){
  if(isLocked)return;
  dayData.trainings.splice(i,1);
  saveDraft();render();
}

/* ================= RENDER ================= */
function render(){
  ensureDayData();
  let kcal = 0, carbs = 0, fat = 0;

  for(let meal in dayData.foods){
    const box = document.querySelector(`#${meal} .foods`);
    box.innerHTML = "";

    dayData.foods[meal].forEach((f, i) => {
      const db = foodsDB[f.id];
      const c = db.carbs ?? 0;
      const r = db.fat   ?? 0;

      const kVal = f.grams * db.kcal / 100;
      const cVal = f.grams * c / 100;
      const rVal = f.grams * r / 100;

      kcal  += kVal;
      carbs += cVal;
      fat   += rVal;

      box.innerHTML += `<div class="item">
        ${f.id.replaceAll("_"," ")} ${f.grams} g
        (${Math.round(kVal)} kcal, ${Math.round(cVal)} hh, ${Math.round(rVal)} r)
        <button onclick="removeFood('${meal}',${i})">❌</button>
      </div>`;
    });
  }

  // Treenit
  const trainBox = document.getElementById("trainings");
  trainBox.innerHTML = "";
  let trainKcal = 0;

  dayData.trainings.forEach((t, i) => {
    trainKcal += t.kcal;
    trainBox.innerHTML += `<div class="item">
      ${t.name} (${t.kcal} kcal)
      <button onclick="removeTraining(${i})">❌</button>
    </div>`;
  });

  // Yhteenveto (pyöristys VASTA TÄSSÄ)
  summary.innerHTML = `
    Ruoasta: ${Math.round(kcal)} kcal, ${Math.round(carbs)} hh, ${Math.round(fat)} r<br>
    Perusaineenvaihdunta: ${BMR} kcal<br>
    Treeneistä: ${trainKcal} kcal<br><br>
    <strong>
      Netto: ${Math.round(kcal - (BMR + trainKcal))} kcal,
      ${Math.round(carbs - CARB_TARGET)} hh,
      ${Math.round(fat - FAT_TARGET)} r
    </strong>
  `;

  renderFiveDaySummary();
}


/* ================= 5 PÄIVÄÄ ================= */
function renderFiveDaySummary(){
  let html = `<h3>5 päivän koonti</h3><div class="summary-boxes">`;
  let totalKcal = 0, totalCarbs = 0, totalFat = 0;

  for(let i = 1; i <= 5; i++){
    const d = new Date(date.value);
    d.setDate(d.getDate() - i);
    const key = d.toISOString().split("T")[0];
    const s = localStorage.getItem(key);

    if(!s){
      html += `<div class="summary-box nodata"><h4>-${i}</h4>Ei dataa</div>`;
      continue;
    }

    const data = JSON.parse(s);
    let kcal = 0, c = 0, r = 0;

    // --- Ruoat ---
    Object.values(data.foods).flat().forEach(f => {
      const db = foodsDB[f.id];
      const carbs = db.carbs ?? 0;
      const fat   = db.fat   ?? 0;

      kcal += f.grams * db.kcal / 100;
      c    += f.grams * carbs / 100;
      r    += f.grams * fat   / 100;
    });

    // --- TREENIT (PUUTTUNUT KOHTA) ---
    const trainKcal = data.trainings.reduce((sum, t) => sum + t.kcal, 0);

    // --- NETOT ---
    const netKcal = kcal - (BMR + trainKcal);

    totalKcal  += netKcal;
    totalCarbs += c - CARB_TARGET;
    totalFat   += r - FAT_TARGET;

    const cls =
      netKcal > 0 ? "positive" :
      netKcal < 0 ? "negative" : "zero";

    html += `<div class="summary-box ${cls}">
      <h4>-${i}</h4>
      ${Math.round(netKcal)} kcal<br>
      ${Math.round(c - CARB_TARGET)} hh<br>
      ${Math.round(r - FAT_TARGET)} r
    </div>`;
  }

  html += `</div>`;
  html += `<br><strong>Yhteensä: ${Math.round(totalKcal)} kcal, ${Math.round(totalCarbs)} hh, ${Math.round(totalFat)} r</strong>`;

  fiveDaySummary.innerHTML = html;
}





/* ================= TALLENNUS ================= */
function saveDraft(){localStorage.setItem("draft-"+date.value,JSON.stringify(dayData));}
function saveDay(){localStorage.setItem(date.value,JSON.stringify(dayData));localStorage.removeItem("draft-"+date.value);lockDay();}
function lockDay(){isLocked=true;content.classList.add("locked");saveBtn.style.display="none";unlockBtn.style.display="block";}
function unlockDay(){isLocked=false;content.classList.remove("locked");saveBtn.style.display="block";unlockBtn.style.display="none";}

date.addEventListener("change",()=>{
  const f=localStorage.getItem(date.value);
  const d=localStorage.getItem("draft-"+date.value);
  if(f){dayData=JSON.parse(f);lockDay();}
  else{isLocked=false;content.classList.remove("locked");saveBtn.style.display="block";unlockBtn.style.display="none";dayData=d?JSON.parse(d):emptyDay();}
  render();
});

/* ================= EXPORT / IMPORT ================= */
function exportJSON(){
  const data={};
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k.match(/^\d{4}-\d{2}-\d{2}$/))data[k]=JSON.parse(localStorage.getItem(k));
  }
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="ruokaseuranta_backup.json";
  a.click();
}

function importJSON(e){
  const file=e.target.files[0];
  if(!file)return;
  const r=new FileReader();
  r.onload=()=>{
    const data=JSON.parse(r.result);
    Object.entries(data).forEach(([k,v])=>{
      Object.values(v.foods).flat().forEach(f=>{
        foodsDB[f.id].carbs ??=0;
        foodsDB[f.id].fat ??=0;
      });
      localStorage.setItem(k,JSON.stringify(v));
    });
    alert("Varmuuskopio palautettu");
  };
  r.readAsText(file);
}
</script>
</body>
</html>
