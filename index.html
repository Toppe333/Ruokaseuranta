<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruokaseuranta</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 750px;
  margin: auto;
  padding: 1rem;
}
.section {
  border: 1px solid #ccc;
  padding: 1rem;
  margin-top: 1rem;
}
.meal-controls, .training-controls {
  display: flex;
  gap: 0.5rem;
}
select, input, button {
  padding: 0.4rem;
}
.meal-controls select {
  flex: 1;
}
.item {
  display: flex;
  justify-content: space-between;
  margin-top: 0.3rem;
}
.locked {
  opacity: 0.6;
  pointer-events: none;
}
.summary-boxes {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 0.5rem;
}
.summary-box {
  border: 1px solid #ccc;
  padding: 0.5rem;
  min-width: 90px;
  text-align: center;
}
.summary-box.positive { background:#e6f4ea; color:#1e6b3a; }
.summary-box.negative { background:#fbeaea; color:#8a1f1f; }
.summary-box.zero { background:#eee; color:#333; }
.summary-box.nodata { background:#f5f5f5; color:#777; font-style:italic; }
</style>
</head>

<body>

<h2>Ruokaseuranta</h2>

<label>Päivä</label>
<input type="date" id="date">

<div id="content">

<!-- ATERIAT -->
<script>
function mealSection(id, title, options) {
  document.write(`
  <div class="section" id="${id}">
    <h3>${title}</h3>
    <div class="meal-controls">
      <select id="${id}Select">
        <option value="">Valitse ruoka</option>
        ${options}
      </select>
      <input type="number" id="${id}Grams" placeholder="g" style="width:70px">
      <button onclick="addFood('${id}')">Lisää</button>
    </div>
    <div class="foods"></div>
  </div>`);
}
</script>

<script>
mealSection("aamupala","Aamupala",`
<option value="kaurapuuro">Kaurapuuro</option>
<option value="leipa">Leipä</option>
<option value="smoothie">Smoothie</option>`);

mealSection("lounas","Lounas",`
<option value="kanapasta">Kanapasta</option>
<option value="salaatti">Salaatti</option>`);

mealSection("illallinen","Illallinen",`
<option value="kanapasta">Kanapasta</option>
<option value="salaatti">Salaatti</option>`);

mealSection("iltapala","Iltapala",`
<option value="rahka">Rahka</option>
<option value="leipa">Leipä</option>`);
</script>

<!-- TREENIT -->
<div class="section">
  <h3>Treenit</h3>
  <div class="training-controls">
    <input id="trainingName" placeholder="Treenin nimi">
    <input id="trainingKcal" type="number" placeholder="kcal">
    <button onclick="addTraining()">Lisää</button>
  </div>
  <div id="trainings"></div>
</div>

<button id="saveBtn" onclick="saveDay()">Tallenna päivä</button>

<div class="section">
  <h3>Yhteenveto</h3>
  <div id="summary"></div>
  <div id="fiveDaySummary"></div>
</div>

</div>

<script>
const BMR = 2000;

// kcal / 100 g
const foodsDB = {
  kaurapuuro: 60,
  leipa: 240,
  smoothie: 70,
  kanapasta: 160,
  salaatti: 80,
  rahka: 60
};

let dayData;
let isLocked = false;

function emptyDay() {
  return { foods:{aamupala:[],lounas:[],illallinen:[],iltapala:[]}, trainings:[] };
}

function addFood(meal) {
  if (isLocked) return;
  const sel = document.getElementById(meal+"Select");
  const grams = document.getElementById(meal+"Grams");
  if (!sel.value || !grams.value) return;

  dayData.foods[meal].push({
    id: sel.value,
    grams: Number(grams.value)
  });

  sel.value = "";
  grams.value = "";
  saveDraft();
  render();
}

function removeFood(meal,i){
  if(isLocked) return;
  dayData.foods[meal].splice(i,1);
  saveDraft(); render();
}

function addTraining(){
  if(isLocked) return;
  if(!trainingName.value||!trainingKcal.value) return;
  dayData.trainings.push({name:trainingName.value,kcal:+trainingKcal.value});
  trainingName.value=""; trainingKcal.value="";
  saveDraft(); render();
}

function removeTraining(i){
  if(isLocked) return;
  dayData.trainings.splice(i,1);
  saveDraft(); render();
}

function foodKcal(item){
  return Math.round(item.grams * foodsDB[item.id] / 100);
}

function render(){
  for(let meal in dayData.foods){
    const box=document.querySelector(`#${meal} .foods`);
    box.innerHTML="";
    dayData.foods[meal].forEach((f,i)=>{
      box.innerHTML+=`
      <div class="item">
        ${f.id} ${f.grams} g (${foodKcal(f)} kcal)
        <button onclick="removeFood('${meal}',${i})">❌</button>
      </div>`;
    });
  }

  trainings.innerHTML="";
  dayData.trainings.forEach((t,i)=>{
    trainings.innerHTML+=`
    <div class="item">
      ${t.name} (${t.kcal} kcal)
      <button onclick="removeTraining(${i})">❌</button>
    </div>`;
  });

  let food=0;
  Object.values(dayData.foods).flat().forEach(f=>food+=foodKcal(f));
  let train=dayData.trainings.reduce((s,t)=>s+t.kcal,0);
  let net=food-(BMR+train);

  summary.innerHTML=`
  Ruoasta: ${food} kcal<br>
  Perusaineenvaihdunta: ${BMR} kcal<br>
  Treeneistä: ${train} kcal<br><br>
  <strong>Netto: ${net} kcal</strong>`;

  renderFiveDaySummary();
}

function renderFiveDaySummary(){
  let html=`<h3>5 päivän koonti</h3><div class="summary-boxes">`;
  let total=0;

  for(let i=1;i<=5;i++){
    const d=new Date(date.value); d.setDate(d.getDate()-i);
    const key=d.toISOString().split("T")[0];
    const s=localStorage.getItem(key);
    if(s){
      const data=JSON.parse(s);
      let food=0;
      Object.values(data.foods).flat().forEach(f=>food+=foodKcal(f));
      let train=data.trainings.reduce((s,t)=>s+t.kcal,0);
      let net=food-(BMR+train);
      total+=net;
      html+=`<div class="summary-box ${net>0?"positive":net<0?"negative":"zero"}"><h4>-${i}</h4>${net} kcal</div>`;
    } else {
      html+=`<div class="summary-box nodata"><h4>-${i}</h4>Ei dataa</div>`;
    }
  }
  html+=`</div><br><strong>Yhteensä: ${total} kcal</strong>`;
  fiveDaySummary.innerHTML=html;
}

function saveDraft(){ localStorage.setItem("draft-"+date.value,JSON.stringify(dayData)); }
function saveDay(){
  if(!date.value) return;
  localStorage.setItem(date.value,JSON.stringify(dayData));
  localStorage.removeItem("draft-"+date.value);
  isLocked=true; content.classList.add("locked"); saveBtn.style.display="none";
}

date.addEventListener("change",()=>{
  const f=localStorage.getItem(date.value);
  const d=localStorage.getItem("draft-"+date.value);
  if(f){ dayData=JSON.parse(f); isLocked=true; content.classList.add("locked"); saveBtn.style.display="none"; }
  else { isLocked=false; content.classList.remove("locked"); saveBtn.style.display="block"; dayData=d?JSON.parse(d):emptyDay(); }
  render();
});
</script>

</body>
</html>
