<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruokaseuranta</title>

<style>
body { font-family: Arial, sans-serif; max-width: 750px; margin: auto; padding: 1rem; }
.section { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; }
.meal-controls, .training-controls { display: flex; gap: 0.5rem; }
select, input, button { padding: 0.4rem; }
.meal-controls select { flex: 1; }
.item { display: flex; justify-content: space-between; margin-top: 0.3rem; }
.locked { opacity: 0.6; pointer-events: none; }

.summary-boxes { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.summary-box { border: 1px solid #ccc; padding: 0.5rem; min-width: 90px; text-align: center; }

.dev-banner {
  background:#fff3cd;
  border:1px solid #ffeeba;
  padding:0.5rem;
  margin-bottom:1rem;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="dev-banner">⚠️ KEHITYSVERSIO – testaa vain DEV-datalla</div>

<h2>Ruokaseuranta</h2>
<h4>versio DEV 2.0</h4>

<label>Päivä</label>
<input type="date" id="date">
<br>
<button id="unlockBtn" style="display:none" onclick="unlockDay()">Muokkaa tietoja</button>

<div id="content">
  <div id="meals"></div>

  <div class="section">
    <h3>Treenit</h3>
    <div class="training-controls">
      <input id="trainingName" placeholder="Treenin nimi">
      <input id="trainingKcal" type="number" placeholder="kcal">
      <button onclick="addTraining()">Lisää</button>
    </div>
    <div id="trainings"></div>
  </div>

  <button id="saveBtn" onclick="saveDay()">Tallenna päivä</button>

  <div class="section">
    <h3>Yhteenveto</h3>
    <div id="summary"></div>
    <div id="fiveDaySummary"></div>
  </div>
</div>

<script>
/* ================= DATA ================= */
const BMR = 2000;

const foodsDB = {
  kaurapuuro_banaani: { kcal:450, carbs:40, fat:3, default:100 },
  kauraleipa: { kcal:120, carbs:20, fat:2, default:100 },
  ruisleipa: { kcal:96, carbs:18, fat:1.5, default:100 },
  appelsiini: { kcal:75, carbs:9, fat:0.2, default:100 },
  mehukeitto: { kcal:44, carbs:10, fat:0, default:400 }
};

const mealFoods = {
  aamupala:["appelsiini","kauraleipa","kaurapuuro_banaani","mehukeitto","ruisleipa"],
  lounas:["kaurapuuro_banaani","ruisleipa"],
  valipalat:["appelsiini","ruisleipa"],
  illallinen:["kauraleipa","ruisleipa"],
  iltapala:["mehukeitto","ruisleipa"]
};

/* ================= STATE ================= */
let dayData, isLocked=false;

function emptyDay(){
  return { foods:{aamupala:[],lounas:[],valipalat:[],illallinen:[],iltapala:[]}, trainings:[] };
}

/* ================= UI BUILD ================= */
function buildMeals(){
  meals.innerHTML="";
  for(const meal in mealFoods){
    meals.innerHTML+=`
      <div class="section" id="${meal}">
        <h3>${meal}</h3>
        <div class="meal-controls">
          <select id="${meal}Select"></select>
          <input id="${meal}Grams" type="number" placeholder="g">
          <button onclick="addFood('${meal}')">Lisää</button>
        </div>
        <div class="foods"></div>
      </div>`;
  }
}

function fillSelects(){
  for(const meal in mealFoods){
    const sel=document.getElementById(meal+"Select");
    sel.innerHTML='<option value="">Valitse</option>';
    mealFoods[meal].forEach(f=>{
      sel.innerHTML+=`<option value="${f}">${f.replaceAll("_"," ")}</option>`;
    });
    sel.onchange=()=>{
      document.getElementById(meal+"Grams").value =
        sel.value ? foodsDB[sel.value].default : "";
    };
  }
}

/* ================= CORE ================= */
function addFood(meal){
  if(isLocked) return;
  const sel=document.getElementById(meal+"Select");
  const g=document.getElementById(meal+"Grams");
  if(!sel.value || !g.value) return;
  dayData.foods[meal].push({id:sel.value, grams:Number(g.value)});
  sel.value=""; g.value="";
  saveDraft(); render();
}

function removeFood(meal,i){
  if(isLocked) return;
  dayData.foods[meal].splice(i,1);
  saveDraft(); render();
}

function addTraining(){
  if(isLocked) return;
  if(!trainingName.value || !trainingKcal.value) return;
  dayData.trainings.push({name:trainingName.value,kcal:Number(trainingKcal.value)});
  trainingName.value=""; trainingKcal.value="";
  saveDraft(); render();
}

function removeTraining(i){
  if(isLocked) return;
  dayData.trainings.splice(i,1);
  saveDraft(); render();
}

/* ================= RENDER ================= */
function render(){
  let kcal=0, carbs=0, fat=0;

  for(const meal in dayData.foods){
    const box=document.querySelector(`#${meal} .foods`);
    box.innerHTML="";
    dayData.foods[meal].forEach((f,i)=>{
      const db=foodsDB[f.id];
      const k=f.grams*db.kcal/100;
      kcal+=k;
      carbs+=f.grams*db.carbs/100;
      fat+=f.grams*db.fat/100;
      box.innerHTML+=`
        <div class="item">
          ${f.id.replaceAll("_"," ")} ${f.grams} g
          <button onclick="removeFood('${meal}',${i})">❌</button>
        </div>`;
    });
  }

  const trainKcal=dayData.trainings.reduce((s,t)=>s+t.kcal,0);
  const net=Math.round(kcal-(BMR+trainKcal));

  summary.innerHTML=`
    <strong>Päivän ravinto:</strong><br>
    Kalorit: ${Math.round(kcal)} kcal<br>
    Hiilarit: ${Math.round(carbs)} g<br>
    Rasva: ${Math.round(fat)} g<br><br>
    Treenit: ${trainKcal} kcal<br>
    <strong>Netto: ${net} kcal</strong>
  `;
}

/* ================= STORAGE ================= */
function saveDraft(){ localStorage.setItem("draft-"+date.value,JSON.stringify(dayData)); }
function saveDay(){ localStorage.setItem(date.value,JSON.stringify(dayData)); localStorage.removeItem("draft-"+date.value); lockDay(); }

function lockDay(){
  isLocked=true;
  content.classList.add("locked");
  saveBtn.style.display="none";
  unlockBtn.style.display="block";
}
function unlockDay(){
  isLocked=false;
  content.classList.remove("locked");
  saveBtn.style.display="block";
  unlockBtn.style.display="none";
}

/* ================= INIT ================= */
buildMeals();
fillSelects();

date.addEventListener("change",()=>{
  const f=localStorage.getItem(date.value);
  const d=localStorage.getItem("draft-"+date.value);
  if(f){ dayData=JSON.parse(f); lockDay(); }
  else { isLocked=false; content.classList.remove("locked"); saveBtn.style.display="block"; unlockBtn.style.display="none"; dayData=d?JSON.parse(d):emptyDay(); }
  render();
});
</script>

</body>
</html>
