<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruokaseuranta</title>

<style>
body { font-family: Arial, sans-serif; max-width: 750px; margin: auto; padding: 1rem; }
.section { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; }
.meal-controls, .training-controls { display: flex; gap: 0.5rem; }
select, input, button { padding: 0.4rem; }
.meal-controls select { flex: 1; }
.item { display: flex; justify-content: space-between; margin-top: 0.3rem; }
.locked { opacity: 0.6; pointer-events: none; }
.summary-boxes { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.summary-box { border: 1px solid #ccc; padding: 0.5rem; min-width: 110px; text-align: center; }
.summary-box.positive { background:#e6f4ea; color:#1e6b3a; }
.summary-box.negative { background:#fbeaea; color:#8a1f1f; }
.summary-box.zero { background:#eee; color:#333; }
.summary-box.nodata { background:#f5f5f5; color:#777; font-style:italic; }
#backupBtn, #jsonBtn { float:right; margin-left:0.5rem; }
</style>
</head>
<body>

<h2>Ruokaseuranta</h2>
<h4>versio 2.0</h4>

<button id="jsonBtn" onclick="downloadJSON()">JSON export</button>
<button id="backupBtn" onclick="downloadCSV()">CSV export</button>

<label>Päivä</label>
<input type="date" id="date">
<button id="unlockBtn" style="display:none;" onclick="unlockDay()">Muokkaa</button>

<div id="content">

<!-- MEALS -->
<script>
const mealNames = {
  aamupala:"Aamupala",
  lounas:"Lounas",
  valipalat:"Välipalat",
  illallinen:"Illallinen",
  iltapala:"Iltapala"
};
</script>

</div>

<div class="section">
<h3>Treenit</h3>
<div class="training-controls">
<input id="trainingName" placeholder="Treenin nimi">
<input id="trainingKcal" type="number" placeholder="kcal">
<button onclick="addTraining()">Lisää</button>
</div>
<div id="trainings"></div>
</div>

<button id="saveBtn" onclick="saveDay()">Tallenna päivä</button>

<div class="section">
<h3>Yhteenveto</h3>
<div id="summary"></div>
<div id="fiveDaySummary"></div>
</div>

<script>
const BMR = 2000;
const DAILY_TARGETS = { carbs:432, fat:72 };

const foodsDB = {
  kauraleipa:{kcal:120,carbs:0,fat:0,default:100},
  ruisleipa:{kcal:96,carbs:0,fat:0,default:100},
  appelsiini:{kcal:75,carbs:0,fat:0,default:100},
  mehukeitto:{kcal:44,carbs:0,fat:0,default:400},
  gluteeniton_pasta:{kcal:356,carbs:0,fat:0,default:0},
  kanakastike_kevyt:{kcal:95,carbs:0,fat:0,default:0},
  peruna:{kcal:75,carbs:0,fat:0,default:0}
};

const mealFoods = {
  aamupala:["kauraleipa","ruisleipa","appelsiini","mehukeitto"],
  valipalat:["kauraleipa","ruisleipa","appelsiini","mehukeitto"],
  iltapala:["kauraleipa","ruisleipa","appelsiini","mehukeitto"],
  lounas:["gluteeniton_pasta","kanakastike_kevyt","peruna"],
  illallinen:["gluteeniton_pasta","kanakastike_kevyt","peruna"]
};

let dayData, isLocked=false;

function emptyDay(){
  return { foods:{aamupala:[],lounas:[],valipalat:[],illallinen:[],iltapala:[]}, trainings:[] };
}

/* ---------- UI BUILD ---------- */
const content=document.getElementById("content");
for(const meal in mealNames){
  content.innerHTML+=`
  <div class="section" id="${meal}">
    <h3>${mealNames[meal]}</h3>
    <div class="meal-controls">
      <select id="${meal}Select"></select>
      <input id="${meal}Grams" type="number" placeholder="g">
      <button onclick="addFood('${meal}')">Lisää</button>
    </div>
    <div class="foods"></div>
  </div>`;
}

function fillSelects(){
  for(const meal in mealFoods){
    const s=document.getElementById(meal+"Select");
    s.innerHTML='<option value="">Valitse</option>';
    mealFoods[meal].forEach(f=>{
      s.innerHTML+=`<option value="${f}">${f.replaceAll("_"," ")}</option>`;
    });
  }
}
fillSelects();

/* ---------- LOGIC ---------- */
function addFood(meal){
  if(isLocked) return;
  const sel=document.getElementById(meal+"Select");
  const g=Number(document.getElementById(meal+"Grams").value);
  if(!sel.value||g<=0) return;
  dayData.foods[meal].push({id:sel.value,grams:g});
  render(); saveDraft();
}

function addTraining(){
  if(isLocked) return;
  if(!trainingName.value||!trainingKcal.value) return;
  dayData.trainings.push({name:trainingName.value,kcal:+trainingKcal.value});
  trainingName.value=""; trainingKcal.value="";
  render(); saveDraft();
}

function render(){
  let totals={kcal:0,carbs:0,fat:0};

  for(const meal in dayData.foods){
    const box=document.querySelector(`#${meal} .foods`);
    box.innerHTML="";
    dayData.foods[meal].forEach(f=>{
      const db=foodsDB[f.id];
      const mult=f.grams/100;
      const kcal=Math.round(db.kcal*mult);
      const c=Math.round(db.carbs*mult);
      const r=Math.round(db.fat*mult);
      totals.kcal+=kcal; totals.carbs+=c; totals.fat+=r;
      box.innerHTML+=`${f.id.replaceAll("_"," ")} ${f.grams} g (${kcal} kcal, ${c}hh, ${r}r)<br>`;
    });
  }

  const trainKcal=dayData.trainings.reduce((s,t)=>s+t.kcal,0);
  const net=Math.round(totals.kcal-(BMR+trainKcal));

  summary.innerHTML=`
    Ruoasta: ${totals.kcal} kcal, ${totals.carbs}hh, ${totals.fat}r<br>
    Perusaineenvaihdunta: ${BMR} kcal<br>
    Treeneistä: ${trainKcal} kcal<br><br>
    <strong>Netto: ${net} kcal</strong>
  `;
}

/* ---------- EXPORT ---------- */
function downloadJSON(){
  const data={};
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k.match(/^\d{4}-\d{2}-\d{2}$/)){
      data[k]=JSON.parse(localStorage.getItem(k));
    }
  }
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="ruokaseuranta_backup.json";
  a.click();
}

/* ---------- STORAGE ---------- */
function saveDraft(){ localStorage.setItem("draft-"+date.value,JSON.stringify(dayData)); }
function saveDay(){ localStorage.setItem(date.value,JSON.stringify(dayData)); lockDay(); }
function lockDay(){ isLocked=true; content.classList.add("locked"); saveBtn.style.display="none"; unlockBtn.style.display="inline"; }
function unlockDay(){ isLocked=false; content.classList.remove("locked"); saveBtn.style.display="inline"; unlockBtn.style.display="none"; }

date.addEventListener("change",()=>{
  const f=localStorage.getItem(date.value);
  dayData=f?JSON.parse(f):emptyDay();
  render();
});
</script>

</body>
</html>
