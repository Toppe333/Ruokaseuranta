<!DOCTYPE html>
<html lang="fi" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Ruokaseuranta</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ TEEMAT ‚îÄ‚îÄ */
[data-theme="dark"] {
  --bg:       #0f0f0f;
  --surface:  #1a1a1a;
  --surface2: #222222;
  --border:   #2e2e2e;
  --text:     #e8e4dc;
  --muted:    #666;
  --accent:   #c8a96e;
  --neg:      #c06060;
  --pos:      #7eb89a;
  --zero:     #888;
  --shadow:   rgba(0,0,0,0.4);
  --modal-bg: rgba(0,0,0,0.7);
}
[data-theme="light"] {
  --bg:       #f5f2ec;
  --surface:  #ffffff;
  --surface2: #f0ece4;
  --border:   #ddd8ce;
  --text:     #2a2520;
  --muted:    #999;
  --accent:   #a07840;
  --neg:      #b04040;
  --pos:      #3a8a62;
  --zero:     #888;
  --shadow:   rgba(0,0,0,0.1);
  --modal-bg: rgba(0,0,0,0.4);
}

/* ‚îÄ‚îÄ ATERIOIDEN V√ÑRIT ‚îÄ‚îÄ */
:root {
  --meal-aamupala:  #6a9fb5;
  --meal-lounas:    #7eb89a;
  --meal-valipalat: #c8a96e;
  --meal-illallinen:#9b7fc7;
  --meal-iltapala:  #c07878;
  --meal-treenit:   #7898c8;
  --r: 8px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Mono', monospace;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 1.5rem 1rem 3rem;
  transition: background 0.2s, color 0.2s;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  margin-bottom: 2rem;
  gap: 1rem;
  flex-wrap: wrap;
}
.header-title h1 {
  font-family: 'Fraunces', serif;
  font-size: 2rem;
  font-weight: 300;
  color: var(--accent);
  letter-spacing: -0.02em;
  line-height: 1;
}
.header-title p { font-size: 0.65rem; color: var(--muted); margin-top: 0.2rem; letter-spacing: 0.1em; text-transform: uppercase; }
.header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
button {
  font-family: 'DM Mono', monospace;
  font-size: 0.75rem;
  padding: 0.5rem 0.9rem;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  border-radius: var(--r);
  cursor: pointer;
  letter-spacing: 0.05em;
  transition: border-color 0.15s, background 0.15s, color 0.15s;
  white-space: nowrap;
}
button:hover { border-color: var(--accent); color: var(--accent); }
button.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 500; }
button.primary:hover { opacity: 0.85; }
button.ghost { background: transparent; border-color: transparent; color: var(--muted); }
button.ghost:hover { color: var(--text); border-color: var(--border); }
button.danger { border-color: transparent; background: transparent; color: var(--neg); padding: 0.3rem 0.5rem; }
button.danger:hover { background: rgba(192,96,96,0.1); }
button.quick { font-size: 0.7rem; padding: 0.3rem 0.6rem; }
button.theme-btn { font-size: 1rem; padding: 0.4rem 0.6rem; }
button.edit-btn { border-color: transparent; background: transparent; color: var(--muted); padding: 0.3rem 0.5rem; font-size: 0.8rem; }
button.edit-btn:hover { color: var(--accent); }
button.preset-btn {
  font-size: 0.7rem;
  padding: 0.35rem 0.7rem;
  color: var(--muted);
  border-color: var(--border);
  background: transparent;
}
button.preset-btn:hover { color: var(--accent); border-color: var(--accent); }

/* ‚îÄ‚îÄ DATE ROW ‚îÄ‚îÄ */
.date-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
input[type="date"] {
  font-family: 'DM Mono', monospace;
  font-size: 0.85rem;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.55rem 0.8rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
}
input[type="date"]:focus { border-color: var(--accent); }

/* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
.status-bar { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.05em; min-height: 1.2em; transition: color 0.2s; }
.status-bar.ok    { color: var(--pos); }
.status-bar.error { color: var(--neg); }

/* ‚îÄ‚îÄ BANNER ‚îÄ‚îÄ */
.day-banner { display: grid; grid-template-columns: repeat(3,1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
.banner-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 0.9rem 1rem; text-align: center; }
.banner-box .label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 0.3rem; }
.banner-box .value { font-family: 'Fraunces', serif; font-size: 1.6rem; font-weight: 600; line-height: 1; }
.banner-box .value.pos { color: var(--pos); }
.banner-box .value.neg { color: var(--neg); }
.banner-box .value.zero { color: var(--zero); }
.banner-box .sub { font-size: 0.62rem; color: var(--muted); margin-top: 0.25rem; }

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.progress-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 0.8rem 1rem; margin-bottom: 1.5rem; }
.progress-label { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.5rem; }
.progress-track { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 3px; transition: width 0.4s ease, background 0.3s; }

/* ‚îÄ‚îÄ MEAL SECTIONS ‚îÄ‚îÄ */
.meal-section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); margin-bottom: 0.75rem; transition: border-color 0.2s; }
.meal-section:not(.open) .meal-header { border-radius: var(--r); }
.meal-section.open .meal-header { border-radius: var(--r) var(--r) 0 0; }

.meal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.8rem 1rem;
  cursor: pointer;
  user-select: none;
  gap: 0.5rem;
  border-left: 3px solid transparent;
  transition: background 0.15s;
}
.meal-header:hover { background: var(--surface2); }
.meal-section.open .meal-header { border-left-color: var(--meal-color); }

.meal-name { font-family: 'Fraunces', serif; font-size: 1rem; font-weight: 300; color: var(--meal-color); font-style: italic; flex: 1; }
.meal-kcal { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.05em; }
.meal-chevron { font-size: 0.7rem; color: var(--muted); transition: transform 0.2s; }
.meal-section.open .meal-chevron { transform: rotate(180deg); }

.meal-body { display: none; padding: 0 1rem 1rem; border-top: 1px solid var(--border); }
.meal-section.open .meal-body { display: block; }

/* ‚îÄ‚îÄ FOOD ITEMS ‚îÄ‚îÄ */
.food-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); gap: 0.5rem; animation: fadeIn 0.2s ease; }
.food-item:last-child { border-bottom: none; }
@keyframes fadeIn { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:none; } }
.food-item-name { font-size: 0.8rem; flex: 1; color: var(--text); }
.food-item-meta { font-size: 0.72rem; color: var(--muted); white-space: nowrap; }
.food-item-actions { display: flex; gap: 0.1rem; align-items: center; }

/* ‚îÄ‚îÄ INLINE EDIT ‚îÄ‚îÄ */
.food-item-edit {
  padding: 0.6rem 0;
  border-bottom: 1px solid var(--border);
  animation: fadeIn 0.2s ease;
}
.food-item-edit:last-child { border-bottom: none; }
.edit-food-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.5rem; }
.edit-food-label { font-size: 0.78rem; color: var(--accent); font-weight: 500; }
.edit-food-actions { display: flex; gap: 0.3rem; }
.edit-food-actions button { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
.edit-change-food { margin-bottom: 0.5rem; }
.edit-change-food .search-wrap { max-width: 100%; }
.edit-slider-row { display: flex; align-items: center; gap: 0.6rem; }
.edit-slider-row input[type="range"] { flex: 1; }
.edit-slider-row input[type="number"] { width: 75px; text-align: center; }

/* ‚îÄ‚îÄ ADD CONTROLS ‚îÄ‚îÄ */
.add-controls { margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.6rem; }
.add-row { display: flex; gap: 0.5rem; align-items: center; }
.add-row-extra { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.1rem; }

/* ‚îÄ‚îÄ SEARCH WRAPPER ‚îÄ‚îÄ */
.search-wrap { position: relative; flex: 1; }
.search-wrap input[type="text"] {
  width: 100%;
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.5rem 0.7rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
}
.search-wrap input[type="text"]:focus { border-color: var(--accent); }
.search-wrap input[type="text"]::placeholder { color: var(--muted); }
.search-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  box-shadow: 0 4px 16px var(--shadow);
}
.search-dropdown.open { display: block; }
.search-option {
  padding: 0.5rem 0.7rem;
  font-size: 0.78rem;
  cursor: pointer;
  transition: background 0.1s;
  color: var(--text);
}
.search-option:hover, .search-option.active { background: var(--surface2); color: var(--accent); }
.search-option.no-results { color: var(--muted); cursor: default; font-style: italic; }

select, input[type="number"] {
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.5rem 0.7rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
  -webkit-appearance: none;
}
select:focus, input[type="number"]:focus { border-color: var(--accent); }
input[type="number"] { width: 80px; text-align: center; }

/* ‚îÄ‚îÄ QUICK PICKS ‚îÄ‚îÄ */
.quick-picks { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.2rem; }

/* ‚îÄ‚îÄ SLIDER ‚îÄ‚îÄ */
.slider-row { display: flex; align-items: center; gap: 0.6rem; margin-top: 0.1rem; }
input[type="range"] {
  flex: 1;
  -webkit-appearance: none;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  transition: transform 0.15s;
}
input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
.slider-label { font-size: 0.68rem; color: var(--muted); white-space: nowrap; min-width: 2.5rem; }
.slider-label.right { text-align: right; }

/* ‚îÄ‚îÄ TRAINING ‚îÄ‚îÄ */
.training-row { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
.training-row input {
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.5rem 0.7rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
}
.training-row input:focus { border-color: var(--accent); }
.training-row input:first-child { flex: 1; min-width: 120px; }
.training-row input[type="number"] { width: 90px; }

/* ‚îÄ‚îÄ 5 DAYS ‚îÄ‚îÄ */
.five-day-section { margin-top: 1.5rem; }
.five-day-section h2 { font-family: 'Fraunces', serif; font-size: 1rem; font-weight: 300; font-style: italic; color: var(--muted); margin-bottom: 0.75rem; }
.five-day-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 0.5rem; }
.day-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 0.7rem 0.5rem; text-align: center; }
.day-card .day-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.4rem; }
.day-card .day-kcal { font-family: 'Fraunces', serif; font-size: 1.1rem; font-weight: 600; line-height: 1; }
.day-card .day-macros { font-size: 0.58rem; color: var(--muted); margin-top: 0.25rem; line-height: 1.5; }
.day-card.pos { border-color: rgba(126,184,154,0.3); } .day-card.pos .day-kcal { color: var(--pos); }
.day-card.neg { border-color: rgba(192,96,96,0.3); }  .day-card.neg .day-kcal { color: var(--neg); }
.day-card.zero .day-kcal { color: var(--zero); }
.day-card.nodata .day-kcal { font-size: 0.7rem; color: var(--muted); font-family: 'DM Mono'; }
.five-day-total { margin-top: 0.75rem; font-size: 0.72rem; color: var(--muted); text-align: right; }
.five-day-total span { color: var(--text); }

/* ‚îÄ‚îÄ LOCKED ‚îÄ‚îÄ */
.content.locked .add-controls { display: none; }
.content.locked .food-item button { pointer-events: none; opacity: 0.3; }

/* ‚îÄ‚îÄ EDIT BAR ‚îÄ‚îÄ */
.edit-bar { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; min-height: 2rem; }
.edit-bar .edit-hint { font-size: 0.68rem; color: var(--muted); letter-spacing: 0.05em; flex: 1; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-backdrop {
  display: none;
  position: fixed; inset: 0;
  background: var(--modal-bg);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}
.modal-backdrop.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 1.5rem;
  width: 100%;
  max-width: 480px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 8px 32px var(--shadow);
}
.modal h3 { font-family: 'Fraunces', serif; font-size: 1.2rem; font-weight: 300; color: var(--accent); margin-bottom: 1rem; font-style: italic; }
.modal-field { margin-bottom: 0.75rem; }
.modal-field label { display: block; font-size: 0.65rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.3rem; }
.modal-field input[type="text"],
.modal-field input[type="number"] {
  width: 100%;
  font-family: 'DM Mono', monospace;
  font-size: 0.82rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.55rem 0.75rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
}
.modal-field input:focus { border-color: var(--accent); }
.meal-checkboxes { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.3rem; }
.meal-check { display: flex; align-items: center; gap: 0.3rem; font-size: 0.72rem; cursor: pointer; }
.meal-check input { cursor: pointer; accent-color: var(--accent); }
.modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.25rem; }

/* ‚îÄ‚îÄ PRESET STYLES ‚îÄ‚îÄ */
.preset-list { margin-top: 0.75rem; }
.preset-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 0.7rem 0.9rem;
  margin-bottom: 0.5rem;
  transition: border-color 0.15s;
}
.preset-card:hover { border-color: var(--accent); }
.preset-card-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
.preset-card-name { font-size: 0.82rem; font-weight: 500; color: var(--text); }
.preset-card-meals { font-size: 0.62rem; color: var(--muted); margin-top: 0.15rem; }
.preset-card-actions { display: flex; gap: 0.3rem; }
.preset-card-foods { margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid var(--border); }
.preset-card-food-item { font-size: 0.7rem; color: var(--muted); padding: 0.15rem 0; }
.preset-card-food-item span { color: var(--text); }

/* Preset picker dropdown (per meal section) */
.preset-picker {
  display: none;
  position: absolute;
  left: 0; right: 0;
  bottom: calc(100% + 4px);
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  max-height: 250px;
  overflow-y: auto;
  z-index: 100;
  box-shadow: 0 4px 16px var(--shadow);
}
.preset-picker.open { display: block; }
.preset-pick-item {
  padding: 0.6rem 0.8rem;
  cursor: pointer;
  transition: background 0.1s;
  border-bottom: 1px solid var(--border);
}
.preset-pick-item:last-child { border-bottom: none; }
.preset-pick-item:hover { background: var(--surface2); }
.preset-pick-name { font-size: 0.78rem; color: var(--accent); font-weight: 500; }
.preset-pick-empty { padding: 0.6rem 0.8rem; font-size: 0.72rem; color: var(--muted); font-style: italic; }

/* Preset builder items in modal */
.preset-builder-items { margin-top: 0.5rem; }
.preset-builder-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.4rem 0 0.4rem 0.75rem; border-bottom: 1px solid var(--border); gap: 0.5rem;
}
.preset-builder-item:last-child { border-bottom: none; }
.preset-builder-item-name { font-size: 0.78rem; flex: 1; }
.preset-builder-item-grams { font-size: 0.72rem; color: var(--muted); }

/* Preset form section labels */
.preset-section-label {
  display: block;
  font-family: 'Fraunces', serif;
  font-size: 0.85rem;
  font-weight: 300;
  font-style: italic;
  color: var(--accent);
  margin-bottom: 0.4rem;
  padding-bottom: 0.3rem;
  border-bottom: 1px solid var(--border);
}

/* Preset card ‚Äî collapsible */
.preset-card-toggle {
  cursor: pointer;
  user-select: none;
  flex: 1;
  padding: 0.3rem 0;
}
.preset-card-chevron {
  font-size: 0.65rem;
  color: var(--muted);
  transition: transform 0.2s;
  margin-left: 0.4rem;
}
.preset-card.expanded .preset-card-chevron { transform: rotate(180deg); }
.preset-card-foods {
  display: none;
  margin-top: 0.4rem;
  padding-top: 0.4rem;
  padding-left: 0.75rem;
  border-top: 1px solid var(--border);
}
.preset-card.expanded .preset-card-foods { display: block; }
.preset-card-food-item { font-size: 0.7rem; color: var(--muted); padding: 0.15rem 0; }
.preset-card-food-item span { color: var(--text); }

/* Preset search dropdown in modal ‚Äî fixed position to escape overflow */
.preset-search-dropdown-fixed {
  position: fixed;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  max-height: 200px;
  overflow-y: auto;
  z-index: 300;
  box-shadow: 0 4px 16px var(--shadow);
}
.preset-search-dropdown-fixed .search-option {
  padding: 0.5rem 0.7rem;
  font-size: 0.78rem;
  cursor: pointer;
  transition: background 0.1s;
  color: var(--text);
}
.preset-search-dropdown-fixed .search-option:hover,
.preset-search-dropdown-fixed .search-option.active { background: var(--surface2); color: var(--accent); }
.preset-search-dropdown-fixed .search-option.no-results { color: var(--muted); cursor: default; font-style: italic; }

/* Preset no-meals hint */
.preset-no-meals-hint {
  font-size: 0.72rem;
  color: var(--muted);
  font-style: italic;
  padding: 0.4rem 0;
}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 500px) {
  .banner-box .value { font-size: 1.2rem; }
  input[type="number"] { width: 70px; }
}

/* ‚îÄ‚îÄ DEV BANNER ‚îÄ‚îÄ */
.dev-banner {
  background: #b04040;
  color: #fff;
  text-align: center;
  padding: 0.4rem 0.8rem;
  font-size: 0.72rem;
  font-weight: 500;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  position: sticky;
  top: 0;
  z-index: 300;
  margin: -1.5rem -1rem 1rem;
}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">
    <h1>Ruokaseuranta</h1>
    <p>v2.4.3 ‚Äî Supabase</p>
  </div>
  <div class="header-actions">
    <button class="theme-btn ghost" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</button>
    <button onclick="downloadCSV()" class="ghost">CSV</button>
    <button onclick="exportJSON()" class="ghost">JSON</button>
    <button onclick="document.getElementById('jsonImport').click()" class="ghost">Tuo JSON</button>
    <button onclick="openAddFoodModal()" class="ghost">+ Ruoka</button>
    <button onclick="openPresetsModal()" class="ghost">üìã Vakioateriat</button>
    <input type="file" id="jsonImport" accept=".json" onchange="importJSON(event)" style="display:none">
  </div>
</div>

<div class="date-row">
  <input type="date" id="date">
  <div id="statusMsg" class="status-bar"></div>
</div>

<div class="day-banner">
  <div class="banner-box">
    <div class="label">Kalorit netto</div>
    <div class="value" id="bannerKcal">‚Äî</div>
    <div class="sub" id="bannerKcalSub"></div>
  </div>
  <div class="banner-box">
    <div class="label">Hiilihydr. netto</div>
    <div class="value" id="bannerCarbs">‚Äî</div>
    <div class="sub" id="bannerCarbsSub"></div>
  </div>
  <div class="banner-box">
    <div class="label">Rasva netto</div>
    <div class="value" id="bannerFat">‚Äî</div>
    <div class="sub" id="bannerFatSub"></div>
  </div>
</div>

<div class="progress-wrap">
  <div class="progress-label">
    <span>Kalorit</span>
    <span id="progressText">0 / 2000 kcal</span>
  </div>
  <div class="progress-track">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>
</div>

<div class="edit-bar" id="editBar" style="display:none">
  <span class="edit-hint">Tallennettu automaattisesti</span>
  <button onclick="unlockDay()" class="ghost">‚úèÔ∏è Muokkaa</button>
</div>

<div class="content" id="content"></div>

<div class="five-day-section">
  <h2>Viimeinen 5 p√§iv√§√§</h2>
  <div class="five-day-grid" id="fiveDayGrid"></div>
  <div class="five-day-total" id="fiveDayTotal"></div>
</div>

<!-- RUOAN LIS√ÑYS MODAL -->
<div class="modal-backdrop" id="addFoodModal">
  <div class="modal">
    <h3>Lis√§√§ uusi ruoka</h3>
    <div class="modal-field">
      <label>Nimi (tunniste, ei v√§lily√∂ntej√§)</label>
      <input type="text" id="nf-name" placeholder="esim. riisipastat">
    </div>
    <div class="modal-field">
      <label>N√§ytt√∂nimi</label>
      <input type="text" id="nf-label" placeholder="esim. Riisipastat">
    </div>
    <div class="modal-field">
      <label>Kalorit / 100g</label>
      <input type="number" id="nf-kcal" placeholder="0">
    </div>
    <div class="modal-field">
      <label>Hiilihydraatit / 100g</label>
      <input type="number" id="nf-carbs" placeholder="0" step="0.1">
    </div>
    <div class="modal-field">
      <label>Rasva / 100g</label>
      <input type="number" id="nf-fat" placeholder="0" step="0.1">
    </div>
    <div class="modal-field">
      <label>Oletusgrammam√§√§r√§</label>
      <input type="number" id="nf-default" placeholder="0">
    </div>
    <div class="modal-field">
      <label>Ateriat</label>
      <div class="meal-checkboxes" id="nf-meals">
        <label class="meal-check"><input type="checkbox" value="aamupala"> Aamupala</label>
        <label class="meal-check"><input type="checkbox" value="lounas"> Lounas</label>
        <label class="meal-check"><input type="checkbox" value="valipalat"> V√§lipalat</label>
        <label class="meal-check"><input type="checkbox" value="illallinen"> Illallinen</label>
        <label class="meal-check"><input type="checkbox" value="iltapala"> Iltapala</label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="ghost" onclick="closeAddFoodModal()">Peruuta</button>
      <button class="primary" onclick="submitNewFood()">Lis√§√§ ruoka</button>
    </div>
  </div>
</div>

<!-- VAKIOATERIAT HALLINTAMODAL -->
<div class="modal-backdrop" id="presetsModal" style="align-items:flex-start;padding-top:2rem">
  <div class="modal" style="max-width:540px;overflow:visible">
    <h3 id="presetsModalTitle">Vakioateriat</h3>
    <div id="presetsModalContent" style="max-height:75vh;overflow-y:auto;overflow-x:visible"></div>
  </div>
</div>

<script>
// =============================================
// ASETUKSET
// =============================================
// ‚îÄ‚îÄ DEV-YMP√ÑRIST√ñ ‚îÄ‚îÄ
const SUPABASE_URL = 'https://slgmbhinbjybvcsxnogl.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZ21iaGluYmp5YnZjc3hub2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyNTc4NzYsImV4cCI6MjA4NzgzMzg3Nn0.qxVfr1qfkqYCDDRHpR9Nk1Rcpcwi7NxU_7vXgE-gJHU';
// ‚îÄ‚îÄ Tuotantoon viet√§ess√§ vaihda n√§m√§: ‚îÄ‚îÄ
// const SUPABASE_URL = 'https://utpvflesczynuwnnembf.supabase.co';
// const SUPABASE_KEY = 'sb_publishable_szsKwGkJ9IYiVZX11HxfOQ_IpGPQxs2';

document.title = 'Ruokaseuranta (DEV)';
{
  const banner = document.createElement('div');
  banner.className = 'dev-banner';
  banner.textContent = '‚ö† DEV-YMP√ÑRIST√ñ';
  document.body.prepend(banner);
}

const BMR          = 2000;
const CARB_TARGET  = 432;
const FAT_TARGET   = 72;
const MEALS        = ['aamupala','lounas','valipalat','illallinen','iltapala'];
const QUICK_GRAMS  = [50, 100, 150, 200, 300];

const MEAL_COLORS = {
  aamupala:  'var(--meal-aamupala)',
  lounas:    'var(--meal-lounas)',
  valipalat: 'var(--meal-valipalat)',
  illallinen:'var(--meal-illallinen)',
  iltapala:  'var(--meal-iltapala)',
  treenit:   'var(--meal-treenit)'
};
const MEAL_LABELS = {
  aamupala:'Aamupala', lounas:'Lounas', valipalat:'V√§lipalat',
  illallinen:'Illallinen', iltapala:'Iltapala', treenit:'Treenit'
};

// =============================================
// TEEMA
// =============================================
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('themeBtn').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('theme', isDark ? 'light' : 'dark');
}
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('themeBtn').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
}

// =============================================
// Supabase
// =============================================
async function sbFetch(path, options = {}) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    ...options,
    headers: {
      'apikey':        SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type':  'application/json',
      'Prefer':        options.prefer || '',
      ...(options.headers || {})
    }
  });
  if (!res.ok) throw new Error(`${res.status}: ${await res.text()}`);
  if (res.status === 204) return null;
  return res.json();
}
const sbGet    = p     => sbFetch(p);
const sbPost   = (p,b) => sbFetch(p, { method:'POST',   body:JSON.stringify(b), prefer:'return=representation' });
const sbPatch  = (p,b) => sbFetch(p, { method:'PATCH',  body:JSON.stringify(b), prefer:'return=representation' });
const sbDelete = p     => sbFetch(p, { method:'DELETE' });

// =============================================
// Tila
// =============================================
let foodsDB         = {};
let presetsDB       = []; // {id, name, meal_types, items:[{id, food_id, food_name, grams}]}
let dayId           = null;
let dayEntries      = { aamupala:[], lounas:[], valipalat:[], illallinen:[], iltapala:[] };
let trainingEntries = [];
let isLocked        = false;
let fiveDayDate     = null;
let selectedFood    = {};
let editingEntry    = {}; // meal -> index being edited

function setStatus(msg, type='') {
  const el = document.getElementById('statusMsg');
  el.textContent = msg;
  el.className = 'status-bar' + (type ? ' '+type : '');
  if (type === 'ok') setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 2500);
}

// =============================================
// Init
// =============================================
async function init() {
  setStatus('Ladataan...');
  try {
    const foods = await sbGet('foods?select=*&order=label.asc');
    foods.forEach(f => {
      foodsDB[f.name] = {
        id: f.id, label: f.label,
        kcal: f.kcal_per_100g, carbs: f.carbs_per_100g, fat: f.fat_per_100g,
        default_grams: f.default_grams, meal_types: f.meal_types
      };
    });
    await loadPresets();
    buildMealSections();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    await loadDay(today);
  } catch(e) { setStatus('Virhe: '+e.message, 'error'); }
}

// =============================================
// Presets ‚Äî lataus
// =============================================
async function loadPresets() {
  try {
    const presets = await sbGet('meal_presets?select=*&order=name.asc');
    if (!presets || !presets.length) { presetsDB = []; return; }
    const presetIds = presets.map(p => p.id).join(',');
    const items = await sbGet(`meal_preset_items?preset_id=in.(${presetIds})&select=*,foods(name,label)`);
    presetsDB = presets.map(p => ({
      id: p.id,
      name: p.name,
      meal_types: p.meal_types || [],
      items: (items || []).filter(it => it.preset_id === p.id).map(it => ({
        id: it.id,
        food_id: it.food_id,
        food_name: it.foods?.name || '',
        food_label: it.foods?.label || '',
        grams: it.grams
      }))
    }));
  } catch(e) {
    console.warn('Preset latausvirhe:', e);
    presetsDB = [];
  }
}

// =============================================
// Rakenna ateriaosiot dynaamisesti
// =============================================
function buildMealSections() {
  const container = document.getElementById('content');
  container.innerHTML = '';
  const allMeals = [...MEALS, 'treenit'];

  allMeals.forEach((meal, idx) => {
    const color  = MEAL_COLORS[meal];
    const label  = MEAL_LABELS[meal];
    const isOpen = idx === 0;

    const sec = document.createElement('div');
    sec.className = 'meal-section' + (isOpen ? ' open' : '');
    sec.id = 'sec-'+meal;
    sec.style.setProperty('--meal-color', color);

    if (meal === 'treenit') {
      sec.innerHTML = `
        <div class="meal-header" onclick="toggleMeal('treenit')">
          <span class="meal-name">${label}</span>
          <span class="meal-kcal" id="kcal-treenit">0 kcal</span>
          <span class="meal-chevron">‚ñº</span>
        </div>
        <div class="meal-body">
          <div class="foods" id="foods-treenit"></div>
          <div class="add-controls">
            <div class="training-row">
              <input id="trainingName" placeholder="Treenin nimi">
              <input id="trainingKcal" type="number" placeholder="kcal">
              <button onclick="addTraining()" class="primary">+</button>
            </div>
          </div>
        </div>`;
    } else {
      sec.innerHTML = `
        <div class="meal-header" onclick="toggleMeal('${meal}')">
          <span class="meal-name">${label}</span>
          <span class="meal-kcal" id="kcal-${meal}">0 kcal</span>
          <span class="meal-chevron">‚ñº</span>
        </div>
        <div class="meal-body">
          <div class="foods" id="foods-${meal}"></div>
          <div class="add-controls">
            <div class="add-row">
              <div class="search-wrap" id="searchwrap-${meal}">
                <input type="text" id="search-${meal}"
                  placeholder="Hae ruokaa..."
                  oninput="filterFoods('${meal}')"
                  onfocus="openDropdown('${meal}')"
                  onkeydown="searchKeydown(event,'${meal}')"
                  autocomplete="off">
                <div class="search-dropdown" id="dropdown-${meal}"></div>
              </div>
              <input type="number" id="g-${meal}" placeholder="g" min="1" max="9999" oninput="syncSlider('${meal}')">
              <button onclick="addFood('${meal}')" class="primary" id="addbtn-${meal}" style="display:none">+</button>
            </div>
            <div class="quick-picks" id="quick-${meal}"></div>
            <div class="slider-row" id="slider-row-${meal}" style="display:none">
              <span class="slider-label" id="slider-min-${meal}">1g</span>
              <input type="range" id="slider-${meal}" min="1" max="500" oninput="syncInput('${meal}')">
              <span class="slider-label right" id="slider-max-${meal}">500g</span>
            </div>
            <div style="position:relative;width:25%;min-width:180px" id="presetwrap-${meal}">
              <button class="preset-btn" onclick="togglePresetPicker('${meal}')" style="width:100%">üìã Vakioateria</button>
              <div class="preset-picker" id="presetpicker-${meal}"></div>
            </div>
          </div>
        </div>`;
    }
    container.appendChild(sec);
  });

  buildQuickPicks();

  // Sulje dropdown & preset picker kun klikataan muualle
  document.addEventListener('click', e => {
    MEALS.forEach(meal => {
      const wrap = document.getElementById('searchwrap-'+meal);
      if (wrap && !wrap.contains(e.target)) closeDropdown(meal);
      const pwrap = document.getElementById('presetwrap-'+meal);
      if (pwrap && !pwrap.contains(e.target)) closePresetPicker(meal);
    });
  });
}

function buildQuickPicks() {
  MEALS.forEach(meal => {
    const wrap = document.getElementById('quick-'+meal);
    if (!wrap) return;
    wrap.innerHTML = '';
    QUICK_GRAMS.forEach(g => {
      const btn = document.createElement('button');
      btn.className = 'quick ghost';
      btn.textContent = g+'g';
      btn.onclick = () => setGrams(meal, g);
      wrap.appendChild(btn);
    });
  });
}

// =============================================
// Pikahaku
// =============================================
function filterFoods(meal, targetEl, dropdownEl, filterMeal) {
  // Overloaded: can be called with just meal (uses defaults) or with explicit elements
  const searchEl = targetEl || document.getElementById('search-'+meal);
  const drop = dropdownEl || document.getElementById('dropdown-'+meal);
  const mealFilter = filterMeal || meal;
  const q = searchEl.value.toLowerCase().trim();
  const opts = Object.entries(foodsDB)
    .filter(([name, f]) => f.meal_types.includes(mealFilter) && (
      f.label.toLowerCase().includes(q) || name.toLowerCase().includes(q)
    ))
    .sort(([,a],[,b]) => a.label.localeCompare(b.label,'fi'));

  drop.innerHTML = '';
  if (!opts.length) {
    drop.innerHTML = '<div class="search-option no-results">Ei tuloksia</div>';
  } else {
    opts.forEach(([name, f], i) => {
      const div = document.createElement('div');
      div.className = 'search-option' + (i === 0 ? ' active' : '');
      div.textContent = f.label;
      div.dataset.name = name;
      drop.appendChild(div);
    });
  }
  drop.classList.add('open');
}

// Simple overload for default meal section search
function filterFoods(meal) {
  const q    = document.getElementById('search-'+meal).value.toLowerCase().trim();
  const drop = document.getElementById('dropdown-'+meal);
  const opts = Object.entries(foodsDB)
    .filter(([name, f]) => f.meal_types.includes(meal) && (
      f.label.toLowerCase().includes(q) || name.toLowerCase().includes(q)
    ))
    .sort(([,a],[,b]) => a.label.localeCompare(b.label,'fi'));

  drop.innerHTML = '';
  if (!opts.length) {
    drop.innerHTML = '<div class="search-option no-results">Ei tuloksia</div>';
  } else {
    opts.forEach(([name, f], i) => {
      const div = document.createElement('div');
      div.className = 'search-option' + (i === 0 ? ' active' : '');
      div.textContent = f.label;
      div.dataset.name = name;
      div.onclick = () => selectFood(meal, name);
      drop.appendChild(div);
    });
  }
  drop.classList.add('open');
}

function openDropdown(meal) { filterFoods(meal); }
function closeDropdown(meal) { document.getElementById('dropdown-'+meal)?.classList.remove('open'); }

function selectFood(meal, name) {
  const f = foodsDB[name];
  selectedFood[meal] = name;
  document.getElementById('search-'+meal).value = f.label;
  closeDropdown(meal);

  const ginp       = document.getElementById('g-'+meal);
  const sliderRow  = document.getElementById('slider-row-'+meal);
  const addBtn     = document.getElementById('addbtn-'+meal);
  ginp.value       = f.default_grams > 0 ? f.default_grams : '';
  sliderRow.style.display = 'flex';
  addBtn.style.display    = 'inline-block';
  updateSliderRange(meal, f.default_grams > 0 ? f.default_grams : 100);
  syncSlider(meal);
}

function searchKeydown(e, meal) {
  const drop    = document.getElementById('dropdown-'+meal);
  const options = drop.querySelectorAll('.search-option:not(.no-results)');
  const active  = drop.querySelector('.search-option.active');
  let idx       = Array.from(options).indexOf(active);

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (idx < options.length-1) { options[idx]?.classList.remove('active'); options[idx+1].classList.add('active'); }
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (idx > 0) { options[idx]?.classList.remove('active'); options[idx-1].classList.add('active'); }
  } else if (e.key === 'Enter') {
    e.preventDefault();
    const sel = drop.querySelector('.search-option.active');
    if (sel?.dataset.name) selectFood(meal, sel.dataset.name);
  } else if (e.key === 'Escape') {
    closeDropdown(meal);
  }
}

// =============================================
// Slider ‚Äî dynaaminen asteikko
// =============================================
function updateSliderRange(meal, currentVal) {
  const slider  = document.getElementById('slider-'+meal);
  const minEl   = document.getElementById('slider-min-'+meal);
  const maxEl   = document.getElementById('slider-max-'+meal);
  const newMax  = Math.max(500, currentVal > 250 ? currentVal * 2 : 500);
  slider.max    = newMax;
  maxEl.textContent = newMax + 'g';
  minEl.textContent = '1g';
}

function setGrams(meal, g) {
  const inp = document.getElementById('g-'+meal);
  inp.value = g;
  updateSliderRange(meal, g);
  syncSlider(meal);
}

function syncSlider(meal) {
  const inp    = document.getElementById('g-'+meal);
  const slider = document.getElementById('slider-'+meal);
  const v      = parseInt(inp.value) || 0;
  if (v > parseInt(slider.max)) updateSliderRange(meal, v);
  slider.value = v;
}

function syncInput(meal) {
  const slider = document.getElementById('slider-'+meal);
  const inp    = document.getElementById('g-'+meal);
  inp.value    = slider.value;
}

// =============================================
// Kollapsit
// =============================================
function toggleMeal(meal) {
  document.getElementById('sec-'+meal)?.classList.toggle('open');
}

// =============================================
// P√§iv√§n lataus
// =============================================
async function loadDay(dateStr) {
  dayId = null;
  dayEntries      = { aamupala:[], lounas:[], valipalat:[], illallinen:[], iltapala:[] };
  trainingEntries = [];
  selectedFood    = {};
  editingEntry    = {};
  setStatus('Ladataan...');

  try {
    const days = await sbGet(`days?date=eq.${dateStr}&select=*`);
    if (days.length > 0) {
      dayId = days[0].id;
      const [entries, trainings] = await Promise.all([
        sbGet(`food_entries?day_id=eq.${dayId}&select=*,foods(name,kcal_per_100g,carbs_per_100g,fat_per_100g)`),
        sbGet(`training_entries?day_id=eq.${dayId}&select=*`)
      ]);
      entries.forEach(e => {
        if (dayEntries[e.meal]) dayEntries[e.meal].push({ entryId:e.id, name:e.foods.name, grams:e.grams, food_id:e.food_id });
      });
      trainingEntries = trainings.map(t => ({ entryId:t.id, name:t.name, kcal:t.kcal }));
      lockDay();
      setStatus('Ladattu ‚úì','ok');
    } else {
      unlockDay();
      setStatus('');
    }
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
  render();

  if (fiveDayDate !== dateStr) {
    fiveDayDate = dateStr;
    renderFiveDaySummary(dateStr);
  }
}

async function ensureDay() {
  if (dayId) return;
  const dateStr = document.getElementById('date').value;
  const result  = await sbPost('days', { date:dateStr, bmr:BMR });
  dayId = result[0].id;
}

// =============================================
// Ruoan lis√§ys / poisto / muokkaus
// =============================================
async function addFood(meal) {
  if (isLocked) return;
  const name = selectedFood[meal];
  if (!name) return;
  const ginp  = document.getElementById('g-'+meal);
  const grams = parseInt(ginp.value);
  if (!grams || grams <= 0) return;
  setStatus('Lis√§t√§√§n...');
  try {
    await ensureDay();
    const food   = foodsDB[name];
    const result = await sbPost('food_entries', { day_id:dayId, meal, food_id:food.id, grams, source:'browser' });
    dayEntries[meal].push({ entryId:result[0].id, name, grams, food_id:food.id });
    document.getElementById('search-'+meal).value = '';
    ginp.value = '';
    document.getElementById('slider-row-'+meal).style.display = 'none';
    document.getElementById('addbtn-'+meal).style.display     = 'none';
    selectedFood[meal] = null;
    setStatus('');
    render();
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

async function removeFood(meal, i) {
  if (isLocked) return;
  const label = foodsDB[dayEntries[meal][i].name]?.label ?? dayEntries[meal][i].name;
  if (!confirm(`Poistetaanko ${label}?`)) return;
  try {
    await sbDelete(`food_entries?id=eq.${dayEntries[meal][i].entryId}`);
    dayEntries[meal].splice(i,1);
    if (editingEntry[meal] === i) delete editingEntry[meal];
    render();
  } catch(e) { setStatus('Poistovirhe: '+e.message,'error'); }
}

// ‚îÄ‚îÄ Muokkaus (inline edit) ‚îÄ‚îÄ
function startEditFood(meal, i) {
  editingEntry[meal] = i;
  render();
}

function cancelEditFood(meal) {
  delete editingEntry[meal];
  render();
}

async function saveEditFood(meal, i) {
  const entry = dayEntries[meal][i];
  const gramsInput = document.getElementById(`edit-grams-${meal}-${i}`);
  const newGrams = parseInt(gramsInput?.value) || entry.grams;

  // Check if food was changed
  const editFoodSel = document.getElementById(`edit-food-sel-${meal}-${i}`);
  let newFoodName = entry.name;
  let newFoodId = entry.food_id;
  if (editFoodSel && editFoodSel.dataset.selectedName) {
    newFoodName = editFoodSel.dataset.selectedName;
    newFoodId = foodsDB[newFoodName].id;
  }

  const patchData = {};
  if (newGrams !== entry.grams) patchData.grams = newGrams;
  if (newFoodId !== entry.food_id) patchData.food_id = newFoodId;

  if (Object.keys(patchData).length === 0) {
    delete editingEntry[meal];
    render();
    return;
  }

  setStatus('Tallennetaan...');
  try {
    await sbPatch(`food_entries?id=eq.${entry.entryId}`, patchData);
    entry.grams = newGrams;
    entry.name = newFoodName;
    entry.food_id = newFoodId;
    delete editingEntry[meal];
    setStatus('Muokattu ‚úì', 'ok');
    render();
  } catch(e) { setStatus('Muokkausvirhe: '+e.message, 'error'); }
}

function syncEditSlider(meal, i) {
  const slider = document.getElementById(`edit-slider-${meal}-${i}`);
  const inp = document.getElementById(`edit-grams-${meal}-${i}`);
  if (slider && inp) {
    const v = parseInt(inp.value) || 0;
    if (v > parseInt(slider.max)) {
      const newMax = Math.max(500, v * 2);
      slider.max = newMax;
    }
    slider.value = v;
  }
}

function syncEditInput(meal, i) {
  const slider = document.getElementById(`edit-slider-${meal}-${i}`);
  const inp = document.getElementById(`edit-grams-${meal}-${i}`);
  if (slider && inp) inp.value = slider.value;
}

// =============================================
// Treenit
// =============================================
async function addTraining() {
  if (isLocked) return;
  const name = document.getElementById('trainingName').value.trim();
  const kcal = parseInt(document.getElementById('trainingKcal').value);
  if (!name || !kcal) return;
  try {
    await ensureDay();
    const result = await sbPost('training_entries', { day_id:dayId, name, kcal });
    trainingEntries.push({ entryId:result[0].id, name, kcal });
    document.getElementById('trainingName').value = '';
    document.getElementById('trainingKcal').value = '';
    render();
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

async function removeTraining(i) {
  if (isLocked) return;
  if (!confirm(`Poistetaanko ${trainingEntries[i].name}?`)) return;
  try {
    await sbDelete(`training_entries?id=eq.${trainingEntries[i].entryId}`);
    trainingEntries.splice(i,1);
    render();
  } catch(e) { setStatus('Poistovirhe: '+e.message,'error'); }
}

// =============================================
// Lukitus
// =============================================
function lockDay() {
  isLocked = true;
  document.getElementById('content').classList.add('locked');
  document.getElementById('editBar').style.display = 'flex';
}
function unlockDay() {
  isLocked = false;
  document.getElementById('content').classList.remove('locked');
  document.getElementById('editBar').style.display = 'none';
}

// =============================================
// Render
// =============================================
function render() {
  let totalKcal=0, totalCarbs=0, totalFat=0, trainKcal=0;

  MEALS.forEach(meal => {
    let mealKcal=0;
    const box = document.getElementById('foods-'+meal);
    if (!box) return;
    box.innerHTML = '';

    dayEntries[meal].forEach((e,i) => {
      const f = foodsDB[e.name];
      if (!f) return;
      const k=e.grams*f.kcal/100, c=e.grams*f.carbs/100, r2=e.grams*f.fat/100;
      totalKcal+=k; totalCarbs+=c; totalFat+=r2; mealKcal+=k;

      // Check if this item is being edited
      if (editingEntry[meal] === i && !isLocked) {
        box.innerHTML += renderEditRow(meal, i, e, f);
      } else {
        box.innerHTML += `<div class="food-item">
          <span class="food-item-name">${f.label}</span>
          <span class="food-item-meta">${e.grams}g ¬∑ ${Math.round(k)} kcal ¬∑ ${Math.round(c)} hh ¬∑ ${Math.round(r2)} r</span>
          <span class="food-item-actions">
            <button class="edit-btn" onclick="startEditFood('${meal}',${i})" title="Muokkaa">‚úèÔ∏è</button>
            <button class="danger" onclick="removeFood('${meal}',${i})">‚úï</button>
          </span>
        </div>`;
      }
    });
    const el = document.getElementById('kcal-'+meal);
    if (el) el.textContent = Math.round(mealKcal) + ' kcal';
  });

  const tBox = document.getElementById('foods-treenit');
  if (tBox) {
    tBox.innerHTML = '';
    trainingEntries.forEach((t,i) => {
      trainKcal += t.kcal;
      tBox.innerHTML += `<div class="food-item">
        <span class="food-item-name">${t.name}</span>
        <span class="food-item-meta">${t.kcal} kcal</span>
        <button class="danger" onclick="removeTraining(${i})">‚úï</button>
      </div>`;
    });
    const el = document.getElementById('kcal-treenit');
    if (el) el.textContent = trainKcal + ' kcal';
  }

  const netKcal  = Math.round(totalKcal-(BMR+trainKcal));
  const netCarbs = Math.round(totalCarbs-CARB_TARGET);
  const netFat   = Math.round(totalFat-FAT_TARGET);

  setVal('bannerKcal',  netKcal,  netKcal>0?'pos':netKcal<0?'neg':'zero');
  setVal('bannerCarbs', netCarbs, netCarbs>0?'pos':netCarbs<0?'neg':'zero');
  setVal('bannerFat',   netFat,   netFat>0?'pos':netFat<0?'neg':'zero');
  document.getElementById('bannerKcalSub').textContent  = `${Math.round(totalKcal)} / ${BMR+trainKcal} kcal`;
  document.getElementById('bannerCarbsSub').textContent = `${Math.round(totalCarbs)} / ${CARB_TARGET} g`;
  document.getElementById('bannerFatSub').textContent   = `${Math.round(totalFat)} / ${FAT_TARGET} g`;

  const pct  = Math.min((totalKcal/(BMR+trainKcal))*100, 120);
  const fill = document.getElementById('progressFill');
  fill.style.width      = pct + '%';
  fill.style.background = pct>100?'var(--neg)':pct>80?'var(--accent)':'var(--pos)';
  document.getElementById('progressText').textContent = `${Math.round(totalKcal)} / ${BMR+trainKcal} kcal`;
}

function renderEditRow(meal, i, entry, food) {
  const grams = entry.grams;
  const maxSlider = Math.max(500, grams > 250 ? grams * 2 : 500);

  // Build food options for dropdown (filtered by this meal type)
  const foodOptions = Object.entries(foodsDB)
    .filter(([,f]) => f.meal_types.includes(meal))
    .sort(([,a],[,b]) => a.label.localeCompare(b.label,'fi'))
    .map(([name, f]) => `<option value="${name}" ${name===entry.name?'selected':''}>${f.label}</option>`)
    .join('');

  return `<div class="food-item-edit">
    <div class="edit-food-header">
      <span class="edit-food-label">Muokkaa: ${food.label}</span>
      <div class="edit-food-actions">
        <button class="primary" onclick="saveEditFood('${meal}',${i})" title="Tallenna">‚úì</button>
        <button class="ghost" onclick="cancelEditFood('${meal}')" title="Peruuta">‚úï</button>
      </div>
    </div>
    <div class="edit-change-food">
      <select id="edit-food-sel-${meal}-${i}" onchange="onEditFoodChange('${meal}',${i})" style="width:100%;margin-bottom:0.4rem;">
        ${foodOptions}
      </select>
    </div>
    <div class="edit-slider-row">
      <input type="range" id="edit-slider-${meal}-${i}" min="1" max="${maxSlider}" value="${grams}" oninput="syncEditInput('${meal}',${i})">
      <input type="number" id="edit-grams-${meal}-${i}" value="${grams}" min="1" max="9999" oninput="syncEditSlider('${meal}',${i})">
      <span style="font-size:0.72rem;color:var(--muted)">g</span>
    </div>
  </div>`;
}

function onEditFoodChange(meal, i) {
  const sel = document.getElementById(`edit-food-sel-${meal}-${i}`);
  if (sel) {
    sel.dataset.selectedName = sel.value;
    // Update default grams hint
    const f = foodsDB[sel.value];
    if (f && f.default_grams) {
      const gramsInp = document.getElementById(`edit-grams-${meal}-${i}`);
      // Don't auto-set, just leave current value ‚Äî user can change if they want
    }
  }
}

function setVal(id, val, cls) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = (val>0?'+':'')+val;
  el.className = 'value '+cls;
}

// =============================================
// Preset picker (per meal section)
// =============================================
function togglePresetPicker(meal) {
  const picker = document.getElementById('presetpicker-'+meal);
  if (picker.classList.contains('open')) {
    closePresetPicker(meal);
    return;
  }
  // Filter presets for this meal type
  const matching = presetsDB.filter(p => p.meal_types.includes(meal));
  picker.innerHTML = '';
  if (!matching.length) {
    picker.innerHTML = '<div class="preset-pick-empty">Ei vakioaterioita t√§lle aterialle</div>';
  } else {
    matching.forEach(p => {
      const div = document.createElement('div');
      div.className = 'preset-pick-item';
      div.innerHTML = `<div class="preset-pick-name">${p.name}</div>`;
      div.onclick = () => applyPreset(meal, p);
      picker.appendChild(div);
    });
  }
  picker.classList.add('open');
}

function closePresetPicker(meal) {
  document.getElementById('presetpicker-'+meal)?.classList.remove('open');
}

async function applyPreset(meal, preset) {
  if (isLocked) return;
  closePresetPicker(meal);
  setStatus('Lis√§t√§√§n vakioateria...');
  try {
    await ensureDay();
    for (const item of preset.items) {
      const f = foodsDB[item.food_name];
      if (!f) continue;
      const result = await sbPost('food_entries', {
        day_id: dayId, meal, food_id: f.id, grams: item.grams, source: 'preset'
      });
      dayEntries[meal].push({ entryId: result[0].id, name: item.food_name, grams: item.grams, food_id: f.id });
    }
    setStatus(`${preset.name} lis√§tty ‚úì`, 'ok');
    render();
  } catch(e) { setStatus('Virhe: '+e.message, 'error'); }
}

// =============================================
// Vakioateriat ‚Äî hallintamodal
// =============================================
function openPresetsModal() {
  document.getElementById('presetsModal').classList.add('open');
  renderPresetsModalList();
}
function closePresetsModal() {
  document.getElementById('presetsModal').classList.remove('open');
  document.getElementById('preset-dropdown-fixed')?.remove();
}

function renderPresetsModalList() {
  const title = document.getElementById('presetsModalTitle');
  const content = document.getElementById('presetsModalContent');
  title.textContent = 'Vakioateriat';

  let html = `<div style="margin-bottom:1rem">
    <button class="primary" onclick="renderPresetCreateForm()">+ Uusi vakioateria</button>
  </div>`;

  if (!presetsDB.length) {
    html += '<p style="font-size:0.78rem;color:var(--muted);font-style:italic">Ei viel√§ vakioaterioita.</p>';
  } else {
    html += '<div class="preset-list">';
    presetsDB.forEach((p, pi) => {
      const mealLabels = p.meal_types.map(m => MEAL_LABELS[m] || m).join(', ');
      const foodsList = p.items.map(it => `<div class="preset-card-food-item"><span>${it.food_label}</span> ${it.grams}g</div>`).join('');
      html += `<div class="preset-card" id="preset-card-${pi}">
        <div class="preset-card-header">
          <div class="preset-card-toggle" onclick="document.getElementById('preset-card-${pi}').classList.toggle('expanded')">
            <div class="preset-card-name">${p.name} <span class="preset-card-chevron">‚ñº</span></div>
            <div class="preset-card-meals">${mealLabels}</div>
          </div>
          <div class="preset-card-actions">
            <button class="edit-btn" onclick="renderPresetEditForm('${p.id}')" title="Muokkaa">‚úèÔ∏è</button>
            <button class="danger" onclick="deletePreset('${p.id}')" title="Poista">‚úï</button>
          </div>
        </div>
        ${p.items.length ? `<div class="preset-card-foods">${foodsList}</div>` : ''}
      </div>`;
    });
    html += '</div>';
  }

  html += `<div class="modal-actions"><button class="ghost" onclick="closePresetsModal()">Sulje</button></div>`;
  content.innerHTML = html;
}

// ‚îÄ‚îÄ Preset create/edit form ‚îÄ‚îÄ
let presetFormItems = []; // temp items while building
let presetFormEditId = null;

function renderPresetCreateForm() {
  presetFormItems = [];
  presetFormEditId = null;
  document.getElementById('preset-dropdown-fixed')?.remove();
  renderPresetForm('Luo vakioateria', '', [], []);
}

function renderPresetEditForm(presetId) {
  const preset = presetsDB.find(p => p.id === presetId);
  if (!preset) return;
  presetFormEditId = presetId;
  presetFormItems = preset.items.map(it => ({ food_name: it.food_name, food_label: it.food_label, grams: it.grams }));
  document.getElementById('preset-dropdown-fixed')?.remove();
  renderPresetForm('Muokkaa vakioateriaa', preset.name, preset.meal_types, presetFormItems);
}

function renderPresetForm(title, name, mealTypes, items) {
  const titleEl = document.getElementById('presetsModalTitle');
  const content = document.getElementById('presetsModalContent');
  titleEl.textContent = title;

  const mealChecks = MEALS.map(m => {
    const checked = mealTypes.includes(m) ? 'checked' : '';
    return `<label class="meal-check"><input type="checkbox" value="${m}" ${checked} onchange="onPresetMealTypeChange()"> ${MEAL_LABELS[m]}</label>`;
  }).join('');

  let itemsHtml = '';
  presetFormItems.forEach((it, i) => {
    itemsHtml += `<div class="preset-builder-item">
      <span class="preset-builder-item-name">${it.food_label}</span>
      <span class="preset-builder-item-grams">${it.grams}g</span>
      <button class="danger" onclick="removePresetFormItem(${i})">‚úï</button>
    </div>`;
  });

  const hasSelectedMeals = mealTypes.length > 0;

  content.innerHTML = `
    <div class="modal-field">
      <label class="preset-section-label">Nimi</label>
      <input type="text" id="preset-name" value="${name}" placeholder="esim. Normaali aamupala">
    </div>
    <div class="modal-field">
      <label class="preset-section-label">Ateriatyypit</label>
      <div class="meal-checkboxes" id="preset-meals">${mealChecks}</div>
    </div>
    <div class="modal-field">
      <label class="preset-section-label">Ruoat</label>
      <div class="preset-builder-items" id="preset-items">${itemsHtml}</div>
      <div style="margin-top:0.6rem" id="preset-search-area">
        ${hasSelectedMeals ? `
        <div class="add-row">
          <div class="search-wrap" id="preset-searchwrap">
            <input type="text" id="preset-search"
              placeholder="Hae ruokaa..."
              oninput="filterPresetFoods()"
              onfocus="filterPresetFoods()"
              onkeydown="presetSearchKeydown(event)"
              autocomplete="off">
          </div>
          <input type="number" id="preset-grams" placeholder="g" min="1" max="9999" style="width:75px">
          <button class="primary" onclick="addPresetFormItem()" id="preset-add-btn" style="display:none">+</button>
        </div>` : '<div class="preset-no-meals-hint">Valitse ensin ateriatyypit yll√§</div>'}
      </div>
    </div>
    <div class="modal-actions">
      <button class="ghost" onclick="renderPresetsModalList()">Peruuta</button>
      <button class="primary" onclick="savePresetForm()">${presetFormEditId ? 'Tallenna muutokset' : 'Luo vakioateria'}</button>
    </div>
  `;

  // Remove old fixed dropdown if exists
  document.getElementById('preset-dropdown-fixed')?.remove();
}

function onPresetMealTypeChange() {
  const selectedMeals = Array.from(document.querySelectorAll('#preset-meals input:checked')).map(cb => cb.value);
  const area = document.getElementById('preset-search-area');
  if (!area) return;

  if (selectedMeals.length === 0) {
    area.innerHTML = '<div class="preset-no-meals-hint">Valitse ensin ateriatyypit yll√§</div>';
    document.getElementById('preset-dropdown-fixed')?.remove();
  } else {
    // Only rebuild if search field doesn't exist yet
    if (!document.getElementById('preset-search')) {
      area.innerHTML = `
        <div class="add-row">
          <div class="search-wrap" id="preset-searchwrap">
            <input type="text" id="preset-search"
              placeholder="Hae ruokaa..."
              oninput="filterPresetFoods()"
              onfocus="filterPresetFoods()"
              onkeydown="presetSearchKeydown(event)"
              autocomplete="off">
          </div>
          <input type="number" id="preset-grams" placeholder="g" min="1" max="9999" style="width:75px">
          <button class="primary" onclick="addPresetFormItem()" id="preset-add-btn" style="display:none">+</button>
        </div>`;
    }
  }
}

let presetSelectedFood = null;

function filterPresetFoods() {
  const searchEl = document.getElementById('preset-search');
  if (!searchEl) return;
  const q = searchEl.value.toLowerCase().trim();

  // Get selected meal types for filtering
  const selectedMeals = Array.from(document.querySelectorAll('#preset-meals input:checked')).map(cb => cb.value);
  if (!selectedMeals.length) return;

  const opts = Object.entries(foodsDB)
    .filter(([name, f]) => {
      const matchesMeal = f.meal_types.some(mt => selectedMeals.includes(mt));
      const matchesQuery = f.label.toLowerCase().includes(q) || name.toLowerCase().includes(q);
      return matchesMeal && matchesQuery;
    })
    .sort(([,a],[,b]) => a.label.localeCompare(b.label,'fi'));

  // Remove old fixed dropdown
  let drop = document.getElementById('preset-dropdown-fixed');
  if (!drop) {
    drop = document.createElement('div');
    drop.id = 'preset-dropdown-fixed';
    drop.className = 'preset-search-dropdown-fixed';
    document.body.appendChild(drop);
  }

  // Position under search field
  const rect = searchEl.getBoundingClientRect();
  drop.style.top = (rect.bottom + 4) + 'px';
  drop.style.left = rect.left + 'px';
  drop.style.width = rect.width + 'px';

  drop.innerHTML = '';
  if (!opts.length) {
    drop.innerHTML = '<div class="search-option no-results">Ei tuloksia</div>';
  } else {
    opts.forEach(([name, f], i) => {
      const div = document.createElement('div');
      div.className = 'search-option' + (i === 0 ? ' active' : '');
      div.textContent = f.label;
      div.dataset.name = name;
      div.onclick = () => selectPresetFood(name);
      drop.appendChild(div);
    });
  }
  drop.style.display = 'block';
}

function closePresetDropdown() {
  const drop = document.getElementById('preset-dropdown-fixed');
  if (drop) drop.style.display = 'none';
}

function selectPresetFood(name) {
  const f = foodsDB[name];
  presetSelectedFood = name;
  document.getElementById('preset-search').value = f.label;
  closePresetDropdown();
  document.getElementById('preset-grams').value = f.default_grams > 0 ? f.default_grams : '';
  document.getElementById('preset-add-btn').style.display = 'inline-block';
}

function presetSearchKeydown(e) {
  const drop = document.getElementById('preset-dropdown-fixed');
  if (!drop) return;
  const options = drop.querySelectorAll('.search-option:not(.no-results)');
  const active = drop.querySelector('.search-option.active');
  let idx = Array.from(options).indexOf(active);

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (idx < options.length-1) { options[idx]?.classList.remove('active'); options[idx+1].classList.add('active'); }
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (idx > 0) { options[idx]?.classList.remove('active'); options[idx-1].classList.add('active'); }
  } else if (e.key === 'Enter') {
    e.preventDefault();
    const sel = drop.querySelector('.search-option.active');
    if (sel?.dataset.name) selectPresetFood(sel.dataset.name);
  } else if (e.key === 'Escape') {
    closePresetDropdown();
  }
}

function addPresetFormItem() {
  if (!presetSelectedFood) return;
  const grams = parseInt(document.getElementById('preset-grams').value);
  if (!grams || grams <= 0) return;
  const f = foodsDB[presetSelectedFood];
  presetFormItems.push({ food_name: presetSelectedFood, food_label: f.label, grams });

  // Re-render items list
  const container = document.getElementById('preset-items');
  let html = '';
  presetFormItems.forEach((it, i) => {
    html += `<div class="preset-builder-item">
      <span class="preset-builder-item-name">${it.food_label}</span>
      <span class="preset-builder-item-grams">${it.grams}g</span>
      <button class="danger" onclick="removePresetFormItem(${i})">‚úï</button>
    </div>`;
  });
  container.innerHTML = html;

  // Reset search
  document.getElementById('preset-search').value = '';
  document.getElementById('preset-grams').value = '';
  document.getElementById('preset-add-btn').style.display = 'none';
  presetSelectedFood = null;
}

function removePresetFormItem(i) {
  presetFormItems.splice(i, 1);
  // Re-render
  const container = document.getElementById('preset-items');
  let html = '';
  presetFormItems.forEach((it, idx) => {
    html += `<div class="preset-builder-item">
      <span class="preset-builder-item-name">${it.food_label}</span>
      <span class="preset-builder-item-grams">${it.grams}g</span>
      <button class="danger" onclick="removePresetFormItem(${idx})">‚úï</button>
    </div>`;
  });
  container.innerHTML = html;
}

async function savePresetForm() {
  const name = document.getElementById('preset-name').value.trim();
  if (!name) { alert('Anna vakioaterialle nimi.'); return; }
  const mealTypes = Array.from(document.querySelectorAll('#preset-meals input:checked')).map(cb => cb.value);
  if (!mealTypes.length) { alert('Valitse v√§hint√§√§n yksi ateriatyyppi.'); return; }
  if (!presetFormItems.length) { alert('Lis√§√§ v√§hint√§√§n yksi ruoka.'); return; }

  setStatus('Tallennetaan...');
  try {
    if (presetFormEditId) {
      // Update existing preset
      await sbPatch(`meal_presets?id=eq.${presetFormEditId}`, { name, meal_types: mealTypes });
      // Delete old items, insert new
      await sbDelete(`meal_preset_items?preset_id=eq.${presetFormEditId}`);
      for (const item of presetFormItems) {
        const f = foodsDB[item.food_name];
        if (!f) continue;
        await sbPost('meal_preset_items', { preset_id: presetFormEditId, food_id: f.id, grams: item.grams });
      }
    } else {
      // Create new preset
      const result = await sbPost('meal_presets', { name, meal_types: mealTypes });
      const presetId = result[0].id;
      for (const item of presetFormItems) {
        const f = foodsDB[item.food_name];
        if (!f) continue;
        await sbPost('meal_preset_items', { preset_id: presetId, food_id: f.id, grams: item.grams });
      }
    }
    await loadPresets();
    setStatus('Vakioateria tallennettu ‚úì', 'ok');
    renderPresetsModalList();
  } catch(e) { setStatus('Virhe: '+e.message, 'error'); }
}

async function deletePreset(presetId) {
  const preset = presetsDB.find(p => p.id === presetId);
  if (!confirm(`Poistetaanko "${preset?.name}"?`)) return;
  try {
    await sbDelete(`meal_presets?id=eq.${presetId}`);
    await loadPresets();
    setStatus('Vakioateria poistettu ‚úì', 'ok');
    renderPresetsModalList();
  } catch(e) { setStatus('Virhe: '+e.message, 'error'); }
}

// =============================================
// 5 p√§iv√§√§ ‚Äî yksi batch-haku
// =============================================
async function renderFiveDaySummary(dateStr) {
  const grid  = document.getElementById('fiveDayGrid');
  const total = document.getElementById('fiveDayTotal');
  grid.innerHTML = '<div style="color:var(--muted);font-size:0.7rem;grid-column:1/-1">Ladataan...</div>';

  const dates = [];
  for (let i=1; i<=5; i++) {
    const d = new Date(dateStr);
    d.setDate(d.getDate()-i);
    dates.push(d.toISOString().split('T')[0]);
  }

  try {
    const datesFilter = dates.map(d=>`"${d}"`).join(',');
    const days = await sbGet(`days?date=in.(${datesFilter})&select=id,date,bmr`);

    const dayMap = {};
    days.forEach(d => { dayMap[d.date] = d; });

    const dayIds = days.map(d=>d.id);
    let entriesMap = {}, trainingsMap = {};

    if (dayIds.length > 0) {
      const idFilter = dayIds.join(',');
      const [entries, trainings] = await Promise.all([
        sbGet(`food_entries?day_id=in.(${idFilter})&select=day_id,grams,foods(kcal_per_100g,carbs_per_100g,fat_per_100g)`),
        sbGet(`training_entries?day_id=in.(${idFilter})&select=day_id,kcal`)
      ]);
      entries.forEach(e => {
        if (!entriesMap[e.day_id]) entriesMap[e.day_id]=[];
        entriesMap[e.day_id].push(e);
      });
      trainings.forEach(t => {
        if (!trainingsMap[t.day_id]) trainingsMap[t.day_id]=[];
        trainingsMap[t.day_id].push(t);
      });
    }

    let tKcal=0, tCarbs=0, tFat=0;
    let html = '';

    dates.forEach(date => {
      const d       = new Date(date);
      const label   = d.toLocaleDateString('fi',{weekday:'short',day:'numeric',month:'numeric'});
      const dayRow  = dayMap[date];
      if (!dayRow) { html += noCard(label); return; }

      const entries   = entriesMap[dayRow.id]  || [];
      const trainings = trainingsMap[dayRow.id] || [];
      let fK=0,fC=0,fF=0;
      entries.forEach(e=>{ fK+=e.grams*e.foods.kcal_per_100g/100; fC+=e.grams*e.foods.carbs_per_100g/100; fF+=e.grams*e.foods.fat_per_100g/100; });
      const tk = trainings.reduce((s,t)=>s+t.kcal,0);
      const nK = Math.round(fK-(dayRow.bmr+tk));
      const nC = Math.round(fC-CARB_TARGET);
      const nF = Math.round(fF-FAT_TARGET);
      tKcal+=nK; tCarbs+=nC; tFat+=nF;
      const cls = nK>0?'pos':nK<0?'neg':'zero';
      html += `<div class="day-card ${cls}">
        <div class="day-label">${label}</div>
        <div class="day-kcal">${nK>0?'+':''}${nK}</div>
        <div class="day-macros">${nC>0?'+':''}${nC} hh<br>${nF>0?'+':''}${nF} r</div>
      </div>`;
    });

    grid.innerHTML = html;
    total.innerHTML = `Yhteens√§: <span>${tKcal>0?'+':''}${tKcal} kcal</span> ¬∑ <span>${tCarbs>0?'+':''}${tCarbs} hh</span> ¬∑ <span>${tFat>0?'+':''}${tFat} r</span>`;

  } catch(e) {
    grid.innerHTML = `<div style="color:var(--neg);font-size:0.7rem;grid-column:1/-1">Virhe: ${e.message}</div>`;
  }
}

function noCard(label) {
  return `<div class="day-card nodata"><div class="day-label">${label}</div><div class="day-kcal">‚Äî</div></div>`;
}

// =============================================
// Ruoan lis√§ys tietokantaan (modal)
// =============================================
function openAddFoodModal() {
  document.getElementById('addFoodModal').classList.add('open');
  document.getElementById('nf-name').focus();
}
function closeAddFoodModal() {
  document.getElementById('addFoodModal').classList.remove('open');
  ['nf-name','nf-label','nf-kcal','nf-carbs','nf-fat','nf-default'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.querySelectorAll('#nf-meals input').forEach(cb => cb.checked = false);
}

async function submitNewFood() {
  const name     = document.getElementById('nf-name').value.trim().toLowerCase().replace(/\s+/g,'_');
  const label    = document.getElementById('nf-label').value.trim();
  const kcal     = parseFloat(document.getElementById('nf-kcal').value) || 0;
  const carbs    = parseFloat(document.getElementById('nf-carbs').value) || 0;
  const fat      = parseFloat(document.getElementById('nf-fat').value) || 0;
  const defG     = parseInt(document.getElementById('nf-default').value) || 0;
  const mealTypes = Array.from(document.querySelectorAll('#nf-meals input:checked')).map(cb=>cb.value);

  if (!name || !label) { alert('Nimi ja n√§ytt√∂nimi ovat pakollisia.'); return; }
  if (!mealTypes.length) { alert('Valitse v√§hint√§√§n yksi ateria.'); return; }

  try {
    const result = await sbPost('foods', {
      name, label,
      kcal_per_100g: kcal,
      carbs_per_100g: carbs,
      fat_per_100g: fat,
      default_grams: defG,
      meal_types: mealTypes
    });
    foodsDB[name] = { id:result[0].id, label, kcal, carbs, fat, default_grams:defG, meal_types:mealTypes };
    closeAddFoodModal();
    setStatus(`${label} lis√§tty ‚úì`, 'ok');
  } catch(e) { alert('Virhe: '+e.message); }
}

// Modal close handlers
document.getElementById('addFoodModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeAddFoodModal();
});
document.getElementById('presetsModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closePresetsModal();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeAddFoodModal();
    closePresetsModal();
    closePresetDropdown();
  }
});
// Close fixed preset dropdown on outside click
document.addEventListener('click', e => {
  const searchEl = document.getElementById('preset-search');
  const dropEl = document.getElementById('preset-dropdown-fixed');
  if (searchEl && dropEl && !searchEl.contains(e.target) && !dropEl.contains(e.target)) {
    closePresetDropdown();
  }
});

// =============================================
// CSV
// =============================================
async function downloadCSV() {
  setStatus('Haetaan...');
  try {
    const days = await sbGet('days?select=id,date,bmr&order=date.asc');
    if (!days.length) { setStatus('Ei dataa','error'); return; }
    const idFilter = days.map(d=>d.id).join(',');
    const [allEntries, allTrainings] = await Promise.all([
      sbGet(`food_entries?day_id=in.(${idFilter})&select=day_id,grams,foods(kcal_per_100g,carbs_per_100g,fat_per_100g)`),
      sbGet(`training_entries?day_id=in.(${idFilter})&select=day_id,kcal`)
    ]);
    const eMap={}, tMap={};
    allEntries.forEach(e=>{ (eMap[e.day_id]=eMap[e.day_id]||[]).push(e); });
    allTrainings.forEach(t=>{ (tMap[t.day_id]=tMap[t.day_id]||[]).push(t); });

    let csv='P√§iv√§m√§√§r√§,Kalorit ruoasta,Hiilihydraatit,Rasva,Treenien kalorit,BMR,Netto kcal,Netto hh,Netto r\n';
    days.forEach(day=>{
      let fK=0,fC=0,fF=0;
      (eMap[day.id]||[]).forEach(e=>{ fK+=e.grams*e.foods.kcal_per_100g/100; fC+=e.grams*e.foods.carbs_per_100g/100; fF+=e.grams*e.foods.fat_per_100g/100; });
      const tk=(tMap[day.id]||[]).reduce((s,t)=>s+t.kcal,0);
      csv+=`${day.date},${Math.round(fK)},${Math.round(fC)},${Math.round(fF)},${tk},${day.bmr},${Math.round(fK-(day.bmr+tk))},${Math.round(fC-CARB_TARGET)},${Math.round(fF-FAT_TARGET)}\n`;
    });
    dlBlob(csv,'ruokaseuranta.csv','text/csv;charset=utf-8;');
    setStatus('CSV valmis ‚úì','ok');
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

// =============================================
// JSON export
// =============================================
async function exportJSON() {
  setStatus('Haetaan...');
  try {
    const days = await sbGet('days?select=*&order=date.asc');
    if (!days.length) { setStatus('Ei dataa','error'); return; }
    const idFilter = days.map(d=>d.id).join(',');
    const [allEntries, allTrainings] = await Promise.all([
      sbGet(`food_entries?day_id=in.(${idFilter})&select=*,foods(name)`),
      sbGet(`training_entries?day_id=in.(${idFilter})&select=*`)
    ]);
    const eMap={}, tMap={};
    allEntries.forEach(e=>{ (eMap[e.day_id]=eMap[e.day_id]||[]).push(e); });
    allTrainings.forEach(t=>{ (tMap[t.day_id]=tMap[t.day_id]||[]).push(t); });

    const out={};
    days.forEach(day=>{
      out[day.date]={
        bmr: day.bmr,
        foods: (eMap[day.id]||[]).map(e=>({ name:e.foods.name, grams:e.grams, meal:e.meal, source:e.source })),
        trainings: (tMap[day.id]||[]).map(t=>({ name:t.name, kcal:t.kcal }))
      };
    });
    dlBlob(JSON.stringify(out,null,2),'ruokaseuranta.json','application/json');
    setStatus('JSON valmis ‚úì','ok');
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

// =============================================
// JSON import
// =============================================
async function importJSON(e) {
  const file=e.target.files[0]; if(!file) return;
  const data=JSON.parse(await file.text());
  setStatus('Tuodaan...'); let count=0;
  try {
    for(const [dateStr,day] of Object.entries(data)){
      let existing=await sbGet(`days?date=eq.${dateStr}&select=id`);
      let dId=existing.length>0?existing[0].id:(await sbPost('days',{date:dateStr,bmr:day.bmr||BMR}))[0].id;
      for(const f of day.foods||[]){
        const entry=Object.entries(foodsDB).find(([n])=>n===f.name);
        if(!entry) continue;
        await sbPost('food_entries',{day_id:dId,meal:f.meal,food_id:entry[1].id,grams:f.grams,source:f.source||'import'});
      }
      for(const t of day.trainings||[]) await sbPost('training_entries',{day_id:dId,name:t.name,kcal:t.kcal});
      count++;
    }
    setStatus(`Tuotu ${count} p√§iv√§√§ ‚úì`,'ok');
    await loadDay(document.getElementById('date').value);
  } catch(err){ setStatus('Virhe: '+err.message,'error'); }
  e.target.value='';
}

function dlBlob(content,filename,type){
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([content],{type})),download:filename});
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

// =============================================
// P√§iv√§n vaihto
// =============================================
document.getElementById('date').addEventListener('change', e => loadDay(e.target.value));

init();
</script>
</body>
</html>
