<!DOCTYPE html>
<html lang="fi" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Ruokaseuranta</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ TEEMAT ‚îÄ‚îÄ */
[data-theme="dark"] {
  --bg:       #0f0f0f;
  --surface:  #1a1a1a;
  --surface2: #222222;
  --border:   #2e2e2e;
  --text:     #e8e4dc;
  --muted:    #666;
  --accent:   #c8a96e;
  --neg:      #c06060;
  --pos:      #7eb89a;
  --zero:     #888;
  --shadow:   rgba(0,0,0,0.4);
  --modal-bg: rgba(0,0,0,0.7);
}
[data-theme="light"] {
  --bg:       #f5f2ec;
  --surface:  #ffffff;
  --surface2: #f0ece4;
  --border:   #ddd8ce;
  --text:     #2a2520;
  --muted:    #999;
  --accent:   #a07840;
  --neg:      #b04040;
  --pos:      #3a8a62;
  --zero:     #888;
  --shadow:   rgba(0,0,0,0.1);
  --modal-bg: rgba(0,0,0,0.4);
}

/* ‚îÄ‚îÄ ATERIOIDEN V√ÑRIT ‚îÄ‚îÄ */
:root {
  --meal-aamupala:  #6a9fb5;
  --meal-lounas:    #7eb89a;
  --meal-valipalat: #c8a96e;
  --meal-illallinen:#9b7fc7;
  --meal-iltapala:  #c07878;
  --meal-treenit:   #7898c8;
  --r: 8px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Mono', monospace;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 1.5rem 1rem 3rem;
  transition: background 0.2s, color 0.2s;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  margin-bottom: 2rem;
  gap: 1rem;
  flex-wrap: wrap;
}
.header-title h1 {
  font-family: 'Fraunces', serif;
  font-size: 2rem;
  font-weight: 300;
  color: var(--accent);
  letter-spacing: -0.02em;
  line-height: 1;
}
.header-title p { font-size: 0.65rem; color: var(--muted); margin-top: 0.2rem; letter-spacing: 0.1em; text-transform: uppercase; }
.header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
button {
  font-family: 'DM Mono', monospace;
  font-size: 0.75rem;
  padding: 0.5rem 0.9rem;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  border-radius: var(--r);
  cursor: pointer;
  letter-spacing: 0.05em;
  transition: border-color 0.15s, background 0.15s, color 0.15s;
  white-space: nowrap;
}
button:hover { border-color: var(--accent); color: var(--accent); }
button.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 500; }
button.primary:hover { opacity: 0.85; }
button.ghost { background: transparent; border-color: transparent; color: var(--muted); }
button.ghost:hover { color: var(--text); border-color: var(--border); }
button.danger { border-color: transparent; background: transparent; color: var(--neg); padding: 0.3rem 0.5rem; }
button.danger:hover { background: rgba(192,96,96,0.1); }
button.quick { font-size: 0.7rem; padding: 0.3rem 0.6rem; }
button.theme-btn { font-size: 1rem; padding: 0.4rem 0.6rem; }

/* ‚îÄ‚îÄ DATE ROW ‚îÄ‚îÄ */
.date-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
input[type="date"] {
  font-family: 'DM Mono', monospace;
  font-size: 0.85rem;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.55rem 0.8rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
}
input[type="date"]:focus { border-color: var(--accent); }

/* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
.status-bar { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.05em; min-height: 1.2em; transition: color 0.2s; }
.status-bar.ok    { color: var(--pos); }
.status-bar.error { color: var(--neg); }

/* ‚îÄ‚îÄ BANNER ‚îÄ‚îÄ */
.day-banner { display: grid; grid-template-columns: repeat(3,1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
.banner-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 0.9rem 1rem; text-align: center; }
.banner-box .label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 0.3rem; }
.banner-box .value { font-family: 'Fraunces', serif; font-size: 1.6rem; font-weight: 600; line-height: 1; }
.banner-box .value.pos { color: var(--pos); }
.banner-box .value.neg { color: var(--neg); }
.banner-box .value.zero { color: var(--zero); }
.banner-box .sub { font-size: 0.62rem; color: var(--muted); margin-top: 0.25rem; }

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.progress-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 0.8rem 1rem; margin-bottom: 1.5rem; }
.progress-label { display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.5rem; }
.progress-track { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 3px; transition: width 0.4s ease, background 0.3s; }

/* ‚îÄ‚îÄ MEAL SECTIONS ‚îÄ‚îÄ */
.meal-section { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); margin-bottom: 0.75rem; transition: border-color 0.2s; }
.meal-section:not(.open) .meal-header { border-radius: var(--r); }
.meal-section.open .meal-header { border-radius: var(--r) var(--r) 0 0; }

.meal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.8rem 1rem;
  cursor: pointer;
  user-select: none;
  gap: 0.5rem;
  border-left: 3px solid transparent;
  transition: background 0.15s;
}
.meal-header:hover { background: var(--surface2); }
.meal-section.open .meal-header { border-left-color: var(--meal-color); }

.meal-name { font-family: 'Fraunces', serif; font-size: 1rem; font-weight: 300; color: var(--meal-color); font-style: italic; flex: 1; }
.meal-kcal { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.05em; }
.meal-chevron { font-size: 0.7rem; color: var(--muted); transition: transform 0.2s; }
.meal-section.open .meal-chevron { transform: rotate(180deg); }

.meal-body { display: none; padding: 0 1rem 1rem; border-top: 1px solid var(--border); }
.meal-section.open .meal-body { display: block; }

/* ‚îÄ‚îÄ FOOD ITEMS ‚îÄ‚îÄ */
.food-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border); gap: 0.5rem; animation: fadeIn 0.2s ease; }
.food-item:last-child { border-bottom: none; }
@keyframes fadeIn { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:none; } }
.food-item-name { font-size: 0.8rem; flex: 1; color: var(--text); }
.food-item-meta { font-size: 0.72rem; color: var(--muted); white-space: nowrap; }

/* ‚îÄ‚îÄ ADD CONTROLS ‚îÄ‚îÄ */
.add-controls { margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.6rem; }
.add-row { display: flex; gap: 0.5rem; align-items: center; }

/* ‚îÄ‚îÄ SEARCH WRAPPER ‚îÄ‚îÄ */
.search-wrap { position: relative; flex: 1; }
.search-wrap input[type="text"] {
  width: 100%;
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.5rem 0.7rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
}
.search-wrap input[type="text"]:focus { border-color: var(--accent); }
.search-wrap input[type="text"]::placeholder { color: var(--muted); }
.search-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  box-shadow: 0 4px 16px var(--shadow);
}
.search-dropdown.open { display: block; }
.search-option {
  padding: 0.5rem 0.7rem;
  font-size: 0.78rem;
  cursor: pointer;
  transition: background 0.1s;
  color: var(--text);
}
.search-option:hover, .search-option.active { background: var(--surface2); color: var(--accent); }
.search-option.no-results { color: var(--muted); cursor: default; font-style: italic; }

select, input[type="number"] {
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.5rem 0.7rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
  -webkit-appearance: none;
}
select:focus, input[type="number"]:focus { border-color: var(--accent); }
input[type="number"] { width: 80px; text-align: center; }

/* ‚îÄ‚îÄ QUICK PICKS ‚îÄ‚îÄ */
.quick-picks { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: 0.2rem; }

/* ‚îÄ‚îÄ SLIDER ‚îÄ‚îÄ */
.slider-row { display: flex; align-items: center; gap: 0.6rem; margin-top: 0.1rem; }
input[type="range"] {
  flex: 1;
  -webkit-appearance: none;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  transition: transform 0.15s;
}
input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
.slider-label { font-size: 0.68rem; color: var(--muted); white-space: nowrap; min-width: 2.5rem; }
.slider-label.right { text-align: right; }

/* ‚îÄ‚îÄ TRAINING ‚îÄ‚îÄ */
.training-row { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
.training-row input {
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.5rem 0.7rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
}
.training-row input:focus { border-color: var(--accent); }
.training-row input:first-child { flex: 1; min-width: 120px; }
.training-row input[type="number"] { width: 90px; }

/* ‚îÄ‚îÄ 5 DAYS ‚îÄ‚îÄ */
.five-day-section { margin-top: 1.5rem; }
.five-day-section h2 { font-family: 'Fraunces', serif; font-size: 1rem; font-weight: 300; font-style: italic; color: var(--muted); margin-bottom: 0.75rem; }
.five-day-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 0.5rem; }
.day-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r); padding: 0.7rem 0.5rem; text-align: center; }
.day-card .day-label { font-size: 0.6rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.4rem; }
.day-card .day-kcal { font-family: 'Fraunces', serif; font-size: 1.1rem; font-weight: 600; line-height: 1; }
.day-card .day-macros { font-size: 0.58rem; color: var(--muted); margin-top: 0.25rem; line-height: 1.5; }
.day-card.pos { border-color: rgba(126,184,154,0.3); } .day-card.pos .day-kcal { color: var(--pos); }
.day-card.neg { border-color: rgba(192,96,96,0.3); }  .day-card.neg .day-kcal { color: var(--neg); }
.day-card.zero .day-kcal { color: var(--zero); }
.day-card.nodata .day-kcal { font-size: 0.7rem; color: var(--muted); font-family: 'DM Mono'; }
.five-day-total { margin-top: 0.75rem; font-size: 0.72rem; color: var(--muted); text-align: right; }
.five-day-total span { color: var(--text); }

/* ‚îÄ‚îÄ LOCKED ‚îÄ‚îÄ */
.content.locked .add-controls { display: none; }
.content.locked .food-item button { pointer-events: none; opacity: 0.3; }

/* ‚îÄ‚îÄ EDIT BAR ‚îÄ‚îÄ */
.edit-bar { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; min-height: 2rem; }
.edit-bar .edit-hint { font-size: 0.68rem; color: var(--muted); letter-spacing: 0.05em; flex: 1; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-backdrop {
  display: none;
  position: fixed; inset: 0;
  background: var(--modal-bg);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}
.modal-backdrop.open { display: flex; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 1.5rem;
  width: 100%;
  max-width: 480px;
  box-shadow: 0 8px 32px var(--shadow);
}
.modal h3 { font-family: 'Fraunces', serif; font-size: 1.2rem; font-weight: 300; color: var(--accent); margin-bottom: 1rem; font-style: italic; }
.modal-field { margin-bottom: 0.75rem; }
.modal-field label { display: block; font-size: 0.65rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 0.3rem; }
.modal-field input[type="text"],
.modal-field input[type="number"] {
  width: 100%;
  font-family: 'DM Mono', monospace;
  font-size: 0.82rem;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.55rem 0.75rem;
  border-radius: var(--r);
  outline: none;
  transition: border-color 0.15s;
}
.modal-field input:focus { border-color: var(--accent); }
.meal-checkboxes { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.3rem; }
.meal-check { display: flex; align-items: center; gap: 0.3rem; font-size: 0.72rem; cursor: pointer; }
.meal-check input { cursor: pointer; accent-color: var(--accent); }
.modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.25rem; }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 500px) {
  .banner-box .value { font-size: 1.2rem; }
  input[type="number"] { width: 70px; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">
    <h1>Ruokaseuranta</h1>
    <p>v2.3.1 ‚Äî Supabase</p>
  </div>
  <div class="header-actions">
    <button class="theme-btn ghost" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</button>
    <button onclick="downloadCSV()" class="ghost">CSV</button>
    <button onclick="exportJSON()" class="ghost">JSON</button>
    <button onclick="document.getElementById('jsonImport').click()" class="ghost">Tuo JSON</button>
    <button onclick="openAddFoodModal()" class="ghost">+ Ruoka</button>
    <input type="file" id="jsonImport" accept=".json" onchange="importJSON(event)" style="display:none">
  </div>
</div>

<div class="date-row">
  <input type="date" id="date">
  <div id="statusMsg" class="status-bar"></div>
</div>

<div class="day-banner">
  <div class="banner-box">
    <div class="label">Kalorit netto</div>
    <div class="value" id="bannerKcal">‚Äî</div>
    <div class="sub" id="bannerKcalSub"></div>
  </div>
  <div class="banner-box">
    <div class="label">Hiilihydr. netto</div>
    <div class="value" id="bannerCarbs">‚Äî</div>
    <div class="sub" id="bannerCarbsSub"></div>
  </div>
  <div class="banner-box">
    <div class="label">Rasva netto</div>
    <div class="value" id="bannerFat">‚Äî</div>
    <div class="sub" id="bannerFatSub"></div>
  </div>
</div>

<div class="progress-wrap">
  <div class="progress-label">
    <span>Kalorit</span>
    <span id="progressText">0 / 2000 kcal</span>
  </div>
  <div class="progress-track">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>
</div>

<div class="edit-bar" id="editBar" style="display:none">
  <span class="edit-hint">Tallennettu automaattisesti</span>
  <button onclick="unlockDay()" class="ghost">‚úèÔ∏è Muokkaa</button>
</div>

<div class="content" id="content"></div>

<div class="five-day-section">
  <h2>Viimeinen 5 p√§iv√§√§</h2>
  <div class="five-day-grid" id="fiveDayGrid"></div>
  <div class="five-day-total" id="fiveDayTotal"></div>
</div>

<!-- RUOAN LIS√ÑYS MODAL -->
<div class="modal-backdrop" id="addFoodModal">
  <div class="modal">
    <h3>Lis√§√§ uusi ruoka</h3>
    <div class="modal-field">
      <label>Nimi (tunniste, ei v√§lily√∂ntej√§)</label>
      <input type="text" id="nf-name" placeholder="esim. riisipastat">
    </div>
    <div class="modal-field">
      <label>N√§ytt√∂nimi</label>
      <input type="text" id="nf-label" placeholder="esim. Riisipastat">
    </div>
    <div class="modal-field">
      <label>Kalorit / 100g</label>
      <input type="number" id="nf-kcal" placeholder="0">
    </div>
    <div class="modal-field">
      <label>Hiilihydraatit / 100g</label>
      <input type="number" id="nf-carbs" placeholder="0" step="0.1">
    </div>
    <div class="modal-field">
      <label>Rasva / 100g</label>
      <input type="number" id="nf-fat" placeholder="0" step="0.1">
    </div>
    <div class="modal-field">
      <label>Oletusgrammam√§√§r√§</label>
      <input type="number" id="nf-default" placeholder="0">
    </div>
    <div class="modal-field">
      <label>Ateriat</label>
      <div class="meal-checkboxes">
        <label class="meal-check"><input type="checkbox" value="aamupala"> Aamupala</label>
        <label class="meal-check"><input type="checkbox" value="lounas"> Lounas</label>
        <label class="meal-check"><input type="checkbox" value="valipalat"> V√§lipalat</label>
        <label class="meal-check"><input type="checkbox" value="illallinen"> Illallinen</label>
        <label class="meal-check"><input type="checkbox" value="iltapala"> Iltapala</label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="ghost" onclick="closeAddFoodModal()">Peruuta</button>
      <button class="primary" onclick="submitNewFood()">Lis√§√§ ruoka</button>
    </div>
  </div>
</div>

<script>
// =============================================
// ASETUKSET
// =============================================
const SUPABASE_URL = 'https://utpvflesczynuwnnembf.supabase.co';
const SUPABASE_KEY = 'sb_publishable_szsKwGkJ9IYiVZX11HxfOQ_IpGPQxs2';
const BMR          = 2000;
const CARB_TARGET  = 432;
const FAT_TARGET   = 72;
const MEALS        = ['aamupala','lounas','valipalat','illallinen','iltapala'];
const QUICK_GRAMS  = [50, 100, 150, 200, 300];

const MEAL_COLORS = {
  aamupala:  'var(--meal-aamupala)',
  lounas:    'var(--meal-lounas)',
  valipalat: 'var(--meal-valipalat)',
  illallinen:'var(--meal-illallinen)',
  iltapala:  'var(--meal-iltapala)',
  treenit:   'var(--meal-treenit)'
};
const MEAL_LABELS = {
  aamupala:'Aamupala', lounas:'Lounas', valipalat:'V√§lipalat',
  illallinen:'Illallinen', iltapala:'Iltapala', treenit:'Treenit'
};

// =============================================
// TEEMA
// =============================================
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('themeBtn').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('theme', isDark ? 'light' : 'dark');
}
// Muista valinta
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('themeBtn').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
}

// =============================================
// Supabase
// =============================================
async function sbFetch(path, options = {}) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    ...options,
    headers: {
      'apikey':        SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type':  'application/json',
      'Prefer':        options.prefer || '',
      ...(options.headers || {})
    }
  });
  if (!res.ok) throw new Error(`${res.status}: ${await res.text()}`);
  if (res.status === 204) return null;
  return res.json();
}
const sbGet    = p     => sbFetch(p);
const sbPost   = (p,b) => sbFetch(p, { method:'POST',   body:JSON.stringify(b), prefer:'return=representation' });
const sbDelete = p     => sbFetch(p, { method:'DELETE' });

// =============================================
// Tila
// =============================================
let foodsDB         = {};
let dayId           = null;
let dayEntries      = { aamupala:[], lounas:[], valipalat:[], illallinen:[], iltapala:[] };
let trainingEntries = [];
let isLocked        = false;
let fiveDayDate     = null;
// Per-meal: valittu ruoka
let selectedFood    = {};

function setStatus(msg, type='') {
  const el = document.getElementById('statusMsg');
  el.textContent = msg;
  el.className = 'status-bar' + (type ? ' '+type : '');
  if (type === 'ok') setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 2500);
}

// =============================================
// Init
// =============================================
async function init() {
  setStatus('Ladataan...');
  try {
    const foods = await sbGet('foods?select=*&order=label.asc');
    foods.forEach(f => {
      foodsDB[f.name] = {
        id: f.id, label: f.label,
        kcal: f.kcal_per_100g, carbs: f.carbs_per_100g, fat: f.fat_per_100g,
        default_grams: f.default_grams, meal_types: f.meal_types
      };
    });
    buildMealSections();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    await loadDay(today);
  } catch(e) { setStatus('Virhe: '+e.message, 'error'); }
}

// =============================================
// Rakenna ateriaosiot dynaamisesti
// =============================================
function buildMealSections() {
  const container = document.getElementById('content');
  container.innerHTML = '';
  const allMeals = [...MEALS, 'treenit'];

  allMeals.forEach((meal, idx) => {
    const color  = MEAL_COLORS[meal];
    const label  = MEAL_LABELS[meal];
    const isOpen = idx === 0;

    const sec = document.createElement('div');
    sec.className = 'meal-section' + (isOpen ? ' open' : '');
    sec.id = 'sec-'+meal;
    sec.style.setProperty('--meal-color', color);

    if (meal === 'treenit') {
      sec.innerHTML = `
        <div class="meal-header" onclick="toggleMeal('treenit')">
          <span class="meal-name">${label}</span>
          <span class="meal-kcal" id="kcal-treenit">0 kcal</span>
          <span class="meal-chevron">‚ñº</span>
        </div>
        <div class="meal-body">
          <div class="foods" id="foods-treenit"></div>
          <div class="add-controls">
            <div class="training-row">
              <input id="trainingName" placeholder="Treenin nimi">
              <input id="trainingKcal" type="number" placeholder="kcal">
              <button onclick="addTraining()" class="primary">+</button>
            </div>
          </div>
        </div>`;
    } else {
      sec.innerHTML = `
        <div class="meal-header" onclick="toggleMeal('${meal}')">
          <span class="meal-name">${label}</span>
          <span class="meal-kcal" id="kcal-${meal}">0 kcal</span>
          <span class="meal-chevron">‚ñº</span>
        </div>
        <div class="meal-body">
          <div class="foods" id="foods-${meal}"></div>
          <div class="add-controls">
            <div class="add-row">
              <div class="search-wrap" id="searchwrap-${meal}">
                <input type="text" id="search-${meal}"
                  placeholder="Hae ruokaa..."
                  oninput="filterFoods('${meal}')"
                  onfocus="openDropdown('${meal}')"
                  onkeydown="searchKeydown(event,'${meal}')"
                  autocomplete="off">
                <div class="search-dropdown" id="dropdown-${meal}"></div>
              </div>
              <input type="number" id="g-${meal}" placeholder="g" min="1" max="9999" oninput="syncSlider('${meal}')">
              <button onclick="addFood('${meal}')" class="primary" id="addbtn-${meal}" style="display:none">+</button>
            </div>
            <div class="quick-picks" id="quick-${meal}"></div>
            <div class="slider-row" id="slider-row-${meal}" style="display:none">
              <span class="slider-label" id="slider-min-${meal}">1g</span>
              <input type="range" id="slider-${meal}" min="1" max="500" oninput="syncInput('${meal}')">
              <span class="slider-label right" id="slider-max-${meal}">500g</span>
            </div>
          </div>
        </div>`;
    }
    container.appendChild(sec);
  });

  buildQuickPicks();

  // Sulje dropdown kun klikataan muualle
  document.addEventListener('click', e => {
    MEALS.forEach(meal => {
      const wrap = document.getElementById('searchwrap-'+meal);
      if (wrap && !wrap.contains(e.target)) closeDropdown(meal);
    });
  });
}

function buildQuickPicks() {
  MEALS.forEach(meal => {
    const wrap = document.getElementById('quick-'+meal);
    if (!wrap) return;
    wrap.innerHTML = '';
    QUICK_GRAMS.forEach(g => {
      const btn = document.createElement('button');
      btn.className = 'quick ghost';
      btn.textContent = g+'g';
      btn.onclick = () => setGrams(meal, g);
      wrap.appendChild(btn);
    });
  });
}

// =============================================
// Pikahaku
// =============================================
function filterFoods(meal) {
  const q    = document.getElementById('search-'+meal).value.toLowerCase().trim();
  const drop = document.getElementById('dropdown-'+meal);
  const opts = Object.entries(foodsDB)
    .filter(([name, f]) => f.meal_types.includes(meal) && (
      f.label.toLowerCase().includes(q) || name.toLowerCase().includes(q)
    ))
    .sort(([,a],[,b]) => a.label.localeCompare(b.label,'fi'));

  drop.innerHTML = '';
  if (!opts.length) {
    drop.innerHTML = '<div class="search-option no-results">Ei tuloksia</div>';
  } else {
    opts.forEach(([name, f], i) => {
      const div = document.createElement('div');
      div.className = 'search-option' + (i === 0 ? ' active' : '');
      div.textContent = f.label;
      div.dataset.name = name;
      div.onclick = () => selectFood(meal, name);
      drop.appendChild(div);
    });
  }
  drop.classList.add('open');
}

function openDropdown(meal) {
  filterFoods(meal);
}

function closeDropdown(meal) {
  document.getElementById('dropdown-'+meal)?.classList.remove('open');
}

function selectFood(meal, name) {
  const f = foodsDB[name];
  selectedFood[meal] = name;
  document.getElementById('search-'+meal).value = f.label;
  closeDropdown(meal);

  const ginp       = document.getElementById('g-'+meal);
  const sliderRow  = document.getElementById('slider-row-'+meal);
  const addBtn     = document.getElementById('addbtn-'+meal);
  ginp.value       = f.default_grams || '';
  sliderRow.style.display = 'flex';
  addBtn.style.display    = 'inline-block';
  updateSliderRange(meal, f.default_grams || 100);
  syncSlider(meal);
}

function searchKeydown(e, meal) {
  const drop    = document.getElementById('dropdown-'+meal);
  const options = drop.querySelectorAll('.search-option:not(.no-results)');
  const active  = drop.querySelector('.search-option.active');
  let idx       = Array.from(options).indexOf(active);

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (idx < options.length-1) { options[idx]?.classList.remove('active'); options[idx+1].classList.add('active'); }
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (idx > 0) { options[idx]?.classList.remove('active'); options[idx-1].classList.add('active'); }
  } else if (e.key === 'Enter') {
    e.preventDefault();
    const sel = drop.querySelector('.search-option.active');
    if (sel?.dataset.name) selectFood(meal, sel.dataset.name);
  } else if (e.key === 'Escape') {
    closeDropdown(meal);
  }
}

// =============================================
// Slider ‚Äî dynaaminen asteikko
// =============================================
function updateSliderRange(meal, currentVal) {
  const slider  = document.getElementById('slider-'+meal);
  const minEl   = document.getElementById('slider-min-'+meal);
  const maxEl   = document.getElementById('slider-max-'+meal);
  // Max on v√§hint√§√§n 500, tai 2x nykyarvo jos yli 250
  const newMax  = Math.max(500, currentVal > 250 ? currentVal * 2 : 500);
  slider.max    = newMax;
  maxEl.textContent = newMax + 'g';
  minEl.textContent = '1g';
}

function setGrams(meal, g) {
  const inp = document.getElementById('g-'+meal);
  inp.value = g;
  updateSliderRange(meal, g);
  syncSlider(meal);
}

function syncSlider(meal) {
  const inp    = document.getElementById('g-'+meal);
  const slider = document.getElementById('slider-'+meal);
  const v      = parseInt(inp.value) || 0;
  // Skaalaa tarvittaessa max
  if (v > parseInt(slider.max)) {
    updateSliderRange(meal, v);
  }
  slider.value = v;
}

function syncInput(meal) {
  const slider = document.getElementById('slider-'+meal);
  const inp    = document.getElementById('g-'+meal);
  inp.value    = slider.value;
}

// =============================================
// Kollapsit
// =============================================
function toggleMeal(meal) {
  document.getElementById('sec-'+meal)?.classList.toggle('open');
}

// =============================================
// P√§iv√§n lataus
// =============================================
async function loadDay(dateStr) {
  dayId = null;
  dayEntries      = { aamupala:[], lounas:[], valipalat:[], illallinen:[], iltapala:[] };
  trainingEntries = [];
  selectedFood    = {};
  setStatus('Ladataan...');

  try {
    const days = await sbGet(`days?date=eq.${dateStr}&select=*`);
    if (days.length > 0) {
      dayId = days[0].id;
      const [entries, trainings] = await Promise.all([
        sbGet(`food_entries?day_id=eq.${dayId}&select=*,foods(name,kcal_per_100g,carbs_per_100g,fat_per_100g)`),
        sbGet(`training_entries?day_id=eq.${dayId}&select=*`)
      ]);
      entries.forEach(e => {
        if (dayEntries[e.meal]) dayEntries[e.meal].push({ entryId:e.id, name:e.foods.name, grams:e.grams });
      });
      trainingEntries = trainings.map(t => ({ entryId:t.id, name:t.name, kcal:t.kcal }));
      lockDay();
      setStatus('Ladattu ‚úì','ok');
    } else {
      unlockDay();
      setStatus('');
    }
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
  render();

  if (fiveDayDate !== dateStr) {
    fiveDayDate = dateStr;
    renderFiveDaySummary(dateStr);
  }
}

async function ensureDay() {
  if (dayId) return;
  const dateStr = document.getElementById('date').value;
  const result  = await sbPost('days', { date:dateStr, bmr:BMR });
  dayId = result[0].id;
}

// =============================================
// Ruoan lis√§ys / poisto
// =============================================
async function addFood(meal) {
  if (isLocked) return;
  const name = selectedFood[meal];
  if (!name) return;
  const ginp  = document.getElementById('g-'+meal);
  const grams = parseInt(ginp.value);
  if (!grams || grams <= 0) return;
  setStatus('Lis√§t√§√§n...');
  try {
    await ensureDay();
    const food   = foodsDB[name];
    const result = await sbPost('food_entries', { day_id:dayId, meal, food_id:food.id, grams, source:'browser' });
    dayEntries[meal].push({ entryId:result[0].id, name, grams });
    // Reset
    document.getElementById('search-'+meal).value     = '';
    ginp.value = '';
    document.getElementById('slider-row-'+meal).style.display = 'none';
    document.getElementById('addbtn-'+meal).style.display     = 'none';
    selectedFood[meal] = null;
    setStatus('');
    render();
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

async function removeFood(meal, i) {
  if (isLocked) return;
  const label = foodsDB[dayEntries[meal][i].name]?.label ?? dayEntries[meal][i].name;
  if (!confirm(`Poistetaanko ${label}?`)) return;
  try {
    await sbDelete(`food_entries?id=eq.${dayEntries[meal][i].entryId}`);
    dayEntries[meal].splice(i,1);
    render();
  } catch(e) { setStatus('Poistovirhe: '+e.message,'error'); }
}

// =============================================
// Treenit
// =============================================
async function addTraining() {
  if (isLocked) return;
  const name = document.getElementById('trainingName').value.trim();
  const kcal = parseInt(document.getElementById('trainingKcal').value);
  if (!name || !kcal) return;
  try {
    await ensureDay();
    const result = await sbPost('training_entries', { day_id:dayId, name, kcal });
    trainingEntries.push({ entryId:result[0].id, name, kcal });
    document.getElementById('trainingName').value = '';
    document.getElementById('trainingKcal').value = '';
    render();
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

async function removeTraining(i) {
  if (isLocked) return;
  if (!confirm(`Poistetaanko ${trainingEntries[i].name}?`)) return;
  try {
    await sbDelete(`training_entries?id=eq.${trainingEntries[i].entryId}`);
    trainingEntries.splice(i,1);
    render();
  } catch(e) { setStatus('Poistovirhe: '+e.message,'error'); }
}

// =============================================
// Lukitus
// =============================================
function lockDay() {
  isLocked = true;
  document.getElementById('content').classList.add('locked');
  document.getElementById('editBar').style.display = 'flex';
}
function unlockDay() {
  isLocked = false;
  document.getElementById('content').classList.remove('locked');
  document.getElementById('editBar').style.display = 'none';
}

// =============================================
// Render
// =============================================
function render() {
  let totalKcal=0, totalCarbs=0, totalFat=0, trainKcal=0;

  MEALS.forEach(meal => {
    let mealKcal=0;
    const box = document.getElementById('foods-'+meal);
    if (!box) return;
    box.innerHTML = '';
    dayEntries[meal].forEach((e,i) => {
      const f = foodsDB[e.name];
      if (!f) return;
      const k=e.grams*f.kcal/100, c=e.grams*f.carbs/100, r=e.grams*f.fat/100;
      totalKcal+=k; totalCarbs+=c; totalFat+=r; mealKcal+=k;
      box.innerHTML += `<div class="food-item">
        <span class="food-item-name">${f.label}</span>
        <span class="food-item-meta">${e.grams}g ¬∑ ${Math.round(k)} kcal ¬∑ ${Math.round(c)} hh ¬∑ ${Math.round(r)} r</span>
        <button class="danger" onclick="removeFood('${meal}',${i})">‚úï</button>
      </div>`;
    });
    const el = document.getElementById('kcal-'+meal);
    if (el) el.textContent = Math.round(mealKcal) + ' kcal';
  });

  const tBox = document.getElementById('foods-treenit');
  if (tBox) {
    tBox.innerHTML = '';
    trainingEntries.forEach((t,i) => {
      trainKcal += t.kcal;
      tBox.innerHTML += `<div class="food-item">
        <span class="food-item-name">${t.name}</span>
        <span class="food-item-meta">${t.kcal} kcal</span>
        <button class="danger" onclick="removeTraining(${i})">‚úï</button>
      </div>`;
    });
    const el = document.getElementById('kcal-treenit');
    if (el) el.textContent = trainKcal + ' kcal';
  }

  const netKcal  = Math.round(totalKcal-(BMR+trainKcal));
  const netCarbs = Math.round(totalCarbs-CARB_TARGET);
  const netFat   = Math.round(totalFat-FAT_TARGET);

  setVal('bannerKcal',  netKcal,  netKcal>0?'pos':netKcal<0?'neg':'zero');
  setVal('bannerCarbs', netCarbs, netCarbs>0?'pos':netCarbs<0?'neg':'zero');
  setVal('bannerFat',   netFat,   netFat>0?'pos':netFat<0?'neg':'zero');
  document.getElementById('bannerKcalSub').textContent  = `${Math.round(totalKcal)} / ${BMR+trainKcal} kcal`;
  document.getElementById('bannerCarbsSub').textContent = `${Math.round(totalCarbs)} / ${CARB_TARGET} g`;
  document.getElementById('bannerFatSub').textContent   = `${Math.round(totalFat)} / ${FAT_TARGET} g`;

  const pct  = Math.min((totalKcal/(BMR+trainKcal))*100, 120);
  const fill = document.getElementById('progressFill');
  fill.style.width      = pct + '%';
  fill.style.background = pct>100?'var(--neg)':pct>80?'var(--accent)':'var(--pos)';
  document.getElementById('progressText').textContent = `${Math.round(totalKcal)} / ${BMR+trainKcal} kcal`;
}

function setVal(id, val, cls) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = (val>0?'+':'')+val;
  el.className = 'value '+cls;
}

// =============================================
// 5 p√§iv√§√§ ‚Äî yksi batch-haku
// =============================================
async function renderFiveDaySummary(dateStr) {
  const grid  = document.getElementById('fiveDayGrid');
  const total = document.getElementById('fiveDayTotal');
  grid.innerHTML = '<div style="color:var(--muted);font-size:0.7rem;grid-column:1/-1">Ladataan...</div>';

  // Laske p√§iv√§m√§√§r√§t
  const dates = [];
  for (let i=1; i<=5; i++) {
    const d = new Date(dateStr);
    d.setDate(d.getDate()-i);
    dates.push(d.toISOString().split('T')[0]);
  }

  try {
    // Hae kaikki 5 p√§iv√§√§ yhdell√§ kutsulla
    const datesFilter = dates.map(d=>`"${d}"`).join(',');
    const [days, allEntries, allTrainings] = await Promise.all([
      sbGet(`days?date=in.(${datesFilter})&select=id,date,bmr`),
      sbGet(`food_entries?day_id=in.(${dates.map(()=>'placeholder').join(',')})&select=day_id,grams,foods(kcal_per_100g,carbs_per_100g,fat_per_100g)`).catch(()=>[]),
      sbGet(`training_entries?select=day_id,kcal`).catch(()=>[])
    ]);

    // J√§rjest√§ p√§iv√§t id:n mukaan
    const dayMap = {};
    days.forEach(d => { dayMap[d.date] = d; });

    // Hae kirjaukset p√§iv√§kohtaisesti (jos dayid lista saatavilla)
    const dayIds = days.map(d=>d.id);
    let entriesMap = {}, trainingsMap = {};

    if (dayIds.length > 0) {
      const idFilter = dayIds.join(',');
      const [entries, trainings] = await Promise.all([
        sbGet(`food_entries?day_id=in.(${idFilter})&select=day_id,grams,foods(kcal_per_100g,carbs_per_100g,fat_per_100g)`),
        sbGet(`training_entries?day_id=in.(${idFilter})&select=day_id,kcal`)
      ]);
      entries.forEach(e => {
        if (!entriesMap[e.day_id]) entriesMap[e.day_id]=[];
        entriesMap[e.day_id].push(e);
      });
      trainings.forEach(t => {
        if (!trainingsMap[t.day_id]) trainingsMap[t.day_id]=[];
        trainingsMap[t.day_id].push(t);
      });
    }

    let tKcal=0, tCarbs=0, tFat=0;
    let html = '';

    dates.forEach((date, i) => {
      const d       = new Date(date);
      const label   = d.toLocaleDateString('fi',{weekday:'short',day:'numeric',month:'numeric'});
      const dayRow  = dayMap[date];
      if (!dayRow) { html += noCard(label); return; }

      const entries   = entriesMap[dayRow.id]  || [];
      const trainings = trainingsMap[dayRow.id] || [];
      let fK=0,fC=0,fF=0;
      entries.forEach(e=>{ fK+=e.grams*e.foods.kcal_per_100g/100; fC+=e.grams*e.foods.carbs_per_100g/100; fF+=e.grams*e.foods.fat_per_100g/100; });
      const tk = trainings.reduce((s,t)=>s+t.kcal,0);
      const nK = Math.round(fK-(dayRow.bmr+tk));
      const nC = Math.round(fC-CARB_TARGET);
      const nF = Math.round(fF-FAT_TARGET);
      tKcal+=nK; tCarbs+=nC; tFat+=nF;
      const cls = nK>0?'pos':nK<0?'neg':'zero';
      html += `<div class="day-card ${cls}">
        <div class="day-label">${label}</div>
        <div class="day-kcal">${nK>0?'+':''}${nK}</div>
        <div class="day-macros">${nC>0?'+':''}${nC} hh<br>${nF>0?'+':''}${nF} r</div>
      </div>`;
    });

    grid.innerHTML = html;
    total.innerHTML = `Yhteens√§: <span>${tKcal>0?'+':''}${tKcal} kcal</span> ¬∑ <span>${tCarbs>0?'+':''}${tCarbs} hh</span> ¬∑ <span>${tFat>0?'+':''}${tFat} r</span>`;

  } catch(e) {
    grid.innerHTML = `<div style="color:var(--neg);font-size:0.7rem;grid-column:1/-1">Virhe: ${e.message}</div>`;
  }
}

function noCard(label) {
  return `<div class="day-card nodata"><div class="day-label">${label}</div><div class="day-kcal">‚Äî</div></div>`;
}

// =============================================
// Ruoan lis√§ys tietokantaan
// =============================================
function openAddFoodModal() {
  document.getElementById('addFoodModal').classList.add('open');
  document.getElementById('nf-name').focus();
}
function closeAddFoodModal() {
  document.getElementById('addFoodModal').classList.remove('open');
  ['nf-name','nf-label','nf-kcal','nf-carbs','nf-fat','nf-default'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.querySelectorAll('.meal-check input').forEach(cb => cb.checked = false);
}

async function submitNewFood() {
  const name     = document.getElementById('nf-name').value.trim().toLowerCase().replace(/\s+/g,'_');
  const label    = document.getElementById('nf-label').value.trim();
  const kcal     = parseFloat(document.getElementById('nf-kcal').value) || 0;
  const carbs    = parseFloat(document.getElementById('nf-carbs').value) || 0;
  const fat      = parseFloat(document.getElementById('nf-fat').value) || 0;
  const defG     = parseInt(document.getElementById('nf-default').value) || 0;
  const mealTypes = Array.from(document.querySelectorAll('.meal-check input:checked')).map(cb=>cb.value);

  if (!name || !label) { alert('Nimi ja n√§ytt√∂nimi ovat pakollisia.'); return; }
  if (!mealTypes.length) { alert('Valitse v√§hint√§√§n yksi ateria.'); return; }

  try {
    const result = await sbPost('foods', {
      name, label,
      kcal_per_100g: kcal,
      carbs_per_100g: carbs,
      fat_per_100g: fat,
      default_grams: defG,
      meal_types: mealTypes
    });
    // Lis√§√§ paikalliseen cacheen heti
    foodsDB[name] = { id:result[0].id, label, kcal, carbs, fat, default_grams:defG, meal_types:mealTypes };
    closeAddFoodModal();
    setStatus(`${label} lis√§tty ‚úì`, 'ok');
  } catch(e) { alert('Virhe: '+e.message); }
}

// Sulje modal Escape-n√§pp√§imell√§ tai taustaa klikkaamalla
document.getElementById('addFoodModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeAddFoodModal();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeAddFoodModal();
});

// =============================================
// CSV
// =============================================
async function downloadCSV() {
  setStatus('Haetaan...');
  try {
    const days = await sbGet('days?select=id,date,bmr&order=date.asc');
    if (!days.length) { setStatus('Ei dataa','error'); return; }
    const idFilter = days.map(d=>d.id).join(',');
    const [allEntries, allTrainings] = await Promise.all([
      sbGet(`food_entries?day_id=in.(${idFilter})&select=day_id,grams,foods(kcal_per_100g,carbs_per_100g,fat_per_100g)`),
      sbGet(`training_entries?day_id=in.(${idFilter})&select=day_id,kcal`)
    ]);
    const eMap={}, tMap={};
    allEntries.forEach(e=>{ (eMap[e.day_id]=eMap[e.day_id]||[]).push(e); });
    allTrainings.forEach(t=>{ (tMap[t.day_id]=tMap[t.day_id]||[]).push(t); });

    let csv='P√§iv√§m√§√§r√§,Kalorit ruoasta,Hiilihydraatit,Rasva,Treenien kalorit,BMR,Netto kcal,Netto hh,Netto r\n';
    days.forEach(day=>{
      let fK=0,fC=0,fF=0;
      (eMap[day.id]||[]).forEach(e=>{ fK+=e.grams*e.foods.kcal_per_100g/100; fC+=e.grams*e.foods.carbs_per_100g/100; fF+=e.grams*e.foods.fat_per_100g/100; });
      const tk=(tMap[day.id]||[]).reduce((s,t)=>s+t.kcal,0);
      csv+=`${day.date},${Math.round(fK)},${Math.round(fC)},${Math.round(fF)},${tk},${day.bmr},${Math.round(fK-(day.bmr+tk))},${Math.round(fC-CARB_TARGET)},${Math.round(fF-FAT_TARGET)}\n`;
    });
    dlBlob(csv,'ruokaseuranta.csv','text/csv;charset=utf-8;');
    setStatus('CSV valmis ‚úì','ok');
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

// =============================================
// JSON export
// =============================================
async function exportJSON() {
  setStatus('Haetaan...');
  try {
    const days = await sbGet('days?select=*&order=date.asc');
    if (!days.length) { setStatus('Ei dataa','error'); return; }
    const idFilter = days.map(d=>d.id).join(',');
    const [allEntries, allTrainings] = await Promise.all([
      sbGet(`food_entries?day_id=in.(${idFilter})&select=*,foods(name)`),
      sbGet(`training_entries?day_id=in.(${idFilter})&select=*`)
    ]);
    const eMap={}, tMap={};
    allEntries.forEach(e=>{ (eMap[e.day_id]=eMap[e.day_id]||[]).push(e); });
    allTrainings.forEach(t=>{ (tMap[t.day_id]=tMap[t.day_id]||[]).push(t); });

    const out={};
    days.forEach(day=>{
      out[day.date]={
        bmr: day.bmr,
        foods: (eMap[day.id]||[]).map(e=>({ name:e.foods.name, grams:e.grams, meal:e.meal, source:e.source })),
        trainings: (tMap[day.id]||[]).map(t=>({ name:t.name, kcal:t.kcal }))
      };
    });
    dlBlob(JSON.stringify(out,null,2),'ruokaseuranta.json','application/json');
    setStatus('JSON valmis ‚úì','ok');
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

// =============================================
// JSON import
// =============================================
async function importJSON(e) {
  const file=e.target.files[0]; if(!file) return;
  const data=JSON.parse(await file.text());
  setStatus('Tuodaan...'); let count=0;
  try {
    for(const [dateStr,day] of Object.entries(data)){
      let existing=await sbGet(`days?date=eq.${dateStr}&select=id`);
      let dId=existing.length>0?existing[0].id:(await sbPost('days',{date:dateStr,bmr:day.bmr||BMR}))[0].id;
      for(const f of day.foods||[]){
        const entry=Object.entries(foodsDB).find(([n])=>n===f.name);
        if(!entry) continue;
        await sbPost('food_entries',{day_id:dId,meal:f.meal,food_id:entry[1].id,grams:f.grams,source:f.source||'import'});
      }
      for(const t of day.trainings||[]) await sbPost('training_entries',{day_id:dId,name:t.name,kcal:t.kcal});
      count++;
    }
    setStatus(`Tuotu ${count} p√§iv√§√§ ‚úì`,'ok');
    await loadDay(document.getElementById('date').value);
  } catch(err){ setStatus('Virhe: '+err.message,'error'); }
  e.target.value='';
}

function dlBlob(content,filename,type){
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([content],{type})),download:filename});
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

// =============================================
// P√§iv√§n vaihto
// =============================================
document.getElementById('date').addEventListener('change', e => loadDay(e.target.value));

init();
</script>
</body>
</html>
