<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ruokaseuranta</title>
<style>
body { font-family: Arial, sans-serif; max-width: 750px; margin: auto; padding: 1rem; }
.section { border: 1px solid #ccc; padding: 1rem; margin-top: 1rem; }
.meal-controls, .training-controls { display: flex; gap: 0.5rem; }
select, input, button { padding: 0.4rem; }
.meal-controls select { flex: 1; }
.item { display: flex; justify-content: space-between; margin-top: 0.3rem; }
.locked { opacity: 0.6; pointer-events: none; }
.summary-boxes { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.summary-box { border: 1px solid #ccc; padding: 0.5rem; min-width: 100px; text-align: center; }
.summary-box.positive { background:#e6f4ea; color:#1e6b3a; }
.summary-box.negative { background:#fbeaea; color:#8a1f1f; }
.summary-box.zero { background:#eee; color:#333; }
.summary-box.nodata { background:#f5f5f5; color:#777; font-style:italic; }
#topButtons { float:right; }
.status { font-size: 0.85rem; color: #666; margin-top: 0.3rem; min-height: 1.2em; }
.status.error { color: #a00; }
.status.ok { color: #1e6b3a; }
</style>
</head>
<body>

<h2>Ruokaseuranta</h2>
<h4>versio 2.1 — Supabase</h4>

<div id="topButtons">
  <button onclick="downloadCSV()">CSV</button>
  <button onclick="exportJSON()">JSON</button>
  <button onclick="document.getElementById('jsonImport').click()">Tuo JSON</button>
  <input type="file" id="jsonImport" accept=".json" onchange="importJSON(event)" style="display:none">
</div>

<label>Päivä</label>
<input type="date" id="date">
<div id="statusMsg" class="status"></div>
<br>
<button id="unlockBtn" style="display:none;" onclick="unlockDay()">Muokkaa tietoja</button>

<div id="content">

<div class="section" id="aamupala"><h3>Aamupala</h3>
<div class="meal-controls">
<select id="aamupalaSelect"></select>
<input type="number" id="aamupalaGrams" placeholder="g">
<button onclick="addFood('aamupala')">Lisää</button>
</div><div class="foods"></div></div>

<div class="section" id="lounas"><h3>Lounas</h3>
<div class="meal-controls">
<select id="lounasSelect"></select>
<input type="number" id="lounasGrams" placeholder="g">
<button onclick="addFood('lounas')">Lisää</button>
</div><div class="foods"></div></div>

<div class="section" id="valipalat"><h3>Välipalat</h3>
<div class="meal-controls">
<select id="valipalatSelect"></select>
<input type="number" id="valipalatGrams" placeholder="g">
<button onclick="addFood('valipalat')">Lisää</button>
</div><div class="foods"></div></div>

<div class="section" id="illallinen"><h3>Illallinen</h3>
<div class="meal-controls">
<select id="illallinenSelect"></select>
<input type="number" id="illallinenGrams" placeholder="g">
<button onclick="addFood('illallinen')">Lisää</button>
</div><div class="foods"></div></div>

<div class="section" id="iltapala"><h3>Iltapala</h3>
<div class="meal-controls">
<select id="iltapalaSelect"></select>
<input type="number" id="iltapalaGrams" placeholder="g">
<button onclick="addFood('iltapala')">Lisää</button>
</div><div class="foods"></div></div>

<div class="section">
<h3>Treenit</h3>
<div class="training-controls">
<input id="trainingName" placeholder="Treenin nimi">
<input id="trainingKcal" type="number" placeholder="kcal">
<button onclick="addTraining()">Lisää</button>
</div>
<div id="trainings"></div>
</div>

<button id="saveBtn" onclick="saveDay()">Tallenna päivä</button>

<div class="section">
<h3>Yhteenveto</h3>
<div id="summary"></div>
<div id="fiveDaySummary"></div>
</div>

</div>

<script>
// =============================================
// ASETUKSET
// =============================================
const SUPABASE_URL = 'https://utpvflesczynuwnnembf.supabase.co';
const SUPABASE_KEY = 'sb_publishable_szsKwGkJ9IYiVZX11HxfOQ_IpGPQxs2';
const BMR          = 2000;
const CARB_TARGET  = 432;
const FAT_TARGET   = 72;
const MEALS        = ['aamupala','lounas','valipalat','illallinen','iltapala'];

// =============================================
// Supabase API
// =============================================
async function sbFetch(path, options = {}) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    ...options,
    headers: {
      'apikey':        SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type':  'application/json',
      'Prefer':        options.prefer || '',
      ...(options.headers || {})
    }
  });
  if (!res.ok) throw new Error(`Supabase ${res.status}: ${await res.text()}`);
  if (res.status === 204) return null;
  return res.json();
}

const sbGet    = path      => sbFetch(path);
const sbPost   = (path, b) => sbFetch(path, { method:'POST',   body:JSON.stringify(b), prefer:'return=representation' });
const sbDelete = path      => sbFetch(path, { method:'DELETE' });

// =============================================
// Tila
// =============================================
let foodsDB         = {};
let dayId           = null;
let dayEntries      = { aamupala:[], lounas:[], valipalat:[], illallinen:[], iltapala:[] };
let trainingEntries = [];
let isLocked        = false;

function setStatus(msg, type='') {
  const el = document.getElementById('statusMsg');
  el.textContent = msg;
  el.className   = 'status' + (type ? ' '+type : '');
}

// =============================================
// Käynnistys
// =============================================
async function init() {
  setStatus('Ladataan ruokia...');
  try {
    const foods = await sbGet('foods?select=*&order=label.asc');
    foods.forEach(f => {
      foodsDB[f.name] = {
        id:            f.id,
        label:         f.label,
        kcal:          f.kcal_per_100g,
        carbs:         f.carbs_per_100g,
        fat:           f.fat_per_100g,
        default_grams: f.default_grams,
        meal_types:    f.meal_types
      };
    });
    fillSelects();
    attachDefaultGrams();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    await loadDay(today);
  } catch(e) {
    setStatus('Virhe: ' + e.message, 'error');
  }
}

// =============================================
// Dropdownit
// =============================================
function fillSelects() {
  MEALS.forEach(meal => {
    const sel = document.getElementById(meal+'Select');
    sel.innerHTML = '<option value="">Valitse ruoka</option>';
    Object.entries(foodsDB)
      .filter(([,f]) => f.meal_types.includes(meal))
      .sort(([,a],[,b]) => a.label.localeCompare(b.label,'fi'))
      .forEach(([name,f]) => {
        sel.innerHTML += `<option value="${name}">${f.label}</option>`;
      });
  });
}

function attachDefaultGrams() {
  MEALS.forEach(meal => {
    const sel = document.getElementById(meal+'Select');
    const gin = document.getElementById(meal+'Grams');
    sel.addEventListener('change', () => {
      gin.value = sel.value ? foodsDB[sel.value].default_grams : '';
    });
  });
}

// =============================================
// Päivän lataus
// =============================================
async function loadDay(dateStr) {
  dayId           = null;
  dayEntries      = { aamupala:[], lounas:[], valipalat:[], illallinen:[], iltapala:[] };
  trainingEntries = [];
  setStatus('Ladataan...');
  try {
    const days = await sbGet(`days?date=eq.${dateStr}&select=*`);
    if (days.length > 0) {
      dayId = days[0].id;
      const [entries, trainings] = await Promise.all([
        sbGet(`food_entries?day_id=eq.${dayId}&select=*,foods(name,kcal_per_100g,carbs_per_100g,fat_per_100g)`),
        sbGet(`training_entries?day_id=eq.${dayId}&select=*`)
      ]);
      entries.forEach(e => {
        if (dayEntries[e.meal]) {
          dayEntries[e.meal].push({ entryId:e.id, name:e.foods.name, grams:e.grams });
        }
      });
      trainingEntries = trainings.map(t => ({ entryId:t.id, name:t.name, kcal:t.kcal }));
      lockDay();
      setStatus('Ladattu ✓', 'ok');
    } else {
      unlockDay();
      setStatus('');
    }
  } catch(e) {
    setStatus('Latausvirhe: ' + e.message, 'error');
  }
  render();
}

// =============================================
// Varmista päivä olemassa
// =============================================
async function ensureDay() {
  if (dayId) return;
  const dateStr = document.getElementById('date').value;
  const result  = await sbPost('days', { date:dateStr, bmr:BMR });
  dayId = result[0].id;
}

// =============================================
// Ruoan lisäys / poisto
// =============================================
async function addFood(meal) {
  if (isLocked) return;
  const sel = document.getElementById(meal+'Select');
  const gin = document.getElementById(meal+'Grams');
  if (!sel.value) return;
  const grams = Number(gin.value);
  if (isNaN(grams) || grams <= 0) return;
  setStatus('Lisätään...');
  try {
    await ensureDay();
    const food   = foodsDB[sel.value];
    const result = await sbPost('food_entries', {
      day_id:dayId, meal, food_id:food.id, grams, source:'browser'
    });
    dayEntries[meal].push({ entryId:result[0].id, name:sel.value, grams });
    sel.value = ''; gin.value = '';
    setStatus('');
    render();
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

async function removeFood(meal, i) {
  if (isLocked) return;
  try {
    await sbDelete(`food_entries?id=eq.${dayEntries[meal][i].entryId}`);
    dayEntries[meal].splice(i,1);
    render();
  } catch(e) { setStatus('Poistovirhe: '+e.message,'error'); }
}

// =============================================
// Treenien lisäys / poisto
// =============================================
async function addTraining() {
  if (isLocked) return;
  const name = document.getElementById('trainingName').value;
  const kcal = Number(document.getElementById('trainingKcal').value);
  if (!name || !kcal) return;
  try {
    await ensureDay();
    const result = await sbPost('training_entries', { day_id:dayId, name, kcal });
    trainingEntries.push({ entryId:result[0].id, name, kcal });
    document.getElementById('trainingName').value = '';
    document.getElementById('trainingKcal').value = '';
    render();
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

async function removeTraining(i) {
  if (isLocked) return;
  try {
    await sbDelete(`training_entries?id=eq.${trainingEntries[i].entryId}`);
    trainingEntries.splice(i,1);
    render();
  } catch(e) { setStatus('Poistovirhe: '+e.message,'error'); }
}

// =============================================
// Tallenna / lukitus
// =============================================
async function saveDay() {
  const dateStr = document.getElementById('date').value;
  if (!dateStr) return;
  setStatus('Tallennetaan...');
  try {
    await ensureDay();
    lockDay();
    setStatus('Tallennettu ✓','ok');
  } catch(e) { setStatus('Tallennusvirhe: '+e.message,'error'); }
}

function lockDay() {
  isLocked = true;
  document.getElementById('content').classList.add('locked');
  document.getElementById('saveBtn').style.display   = 'none';
  document.getElementById('unlockBtn').style.display = 'block';
}
function unlockDay() {
  isLocked = false;
  document.getElementById('content').classList.remove('locked');
  document.getElementById('saveBtn').style.display   = 'block';
  document.getElementById('unlockBtn').style.display = 'none';
}

// =============================================
// Renderöinti
// =============================================
function render() {
  let kcal=0, carbs=0, fat=0;

  MEALS.forEach(meal => {
    const box = document.querySelector(`#${meal} .foods`);
    box.innerHTML = '';
    dayEntries[meal].forEach((e,i) => {
      const f = foodsDB[e.name];
      if (!f) return;
      const kVal = e.grams * f.kcal  / 100;
      const cVal = e.grams * f.carbs / 100;
      const rVal = e.grams * f.fat   / 100;
      kcal  += kVal; carbs += cVal; fat += rVal;
      box.innerHTML += `<div class="item">
        ${f.label} ${e.grams} g
        (${Math.round(kVal)} kcal, ${Math.round(cVal)} hh, ${Math.round(rVal)} r)
        <button onclick="removeFood('${meal}',${i})">❌</button>
      </div>`;
    });
  });

  const trainBox = document.getElementById('trainings');
  trainBox.innerHTML = '';
  let trainKcal = 0;
  trainingEntries.forEach((t,i) => {
    trainKcal += t.kcal;
    trainBox.innerHTML += `<div class="item">
      ${t.name} (${t.kcal} kcal)
      <button onclick="removeTraining(${i})">❌</button>
    </div>`;
  });

  document.getElementById('summary').innerHTML = `
    Ruoasta: ${Math.round(kcal)} kcal, ${Math.round(carbs)} hh, ${Math.round(fat)} r<br>
    Perusaineenvaihdunta: ${BMR} kcal<br>
    Treeneistä: ${trainKcal} kcal<br><br>
    <strong>Netto: ${Math.round(kcal-(BMR+trainKcal))} kcal,
    ${Math.round(carbs-CARB_TARGET)} hh,
    ${Math.round(fat-FAT_TARGET)} r</strong>
  `;

  renderFiveDaySummary();
}

// =============================================
// 5 päivän koonti
// =============================================
async function renderFiveDaySummary() {
  const dateStr = document.getElementById('date').value;
  if (!dateStr) return;
  let html = `<h3>5 päivän koonti</h3><div class="summary-boxes">`;
  let totalKcal=0, totalCarbs=0, totalFat=0;

  for (let i=1; i<=5; i++) {
    const d = new Date(dateStr);
    d.setDate(d.getDate()-i);
    const key = d.toISOString().split('T')[0];
    try {
      const days = await sbGet(`days?date=eq.${key}&select=id,bmr`);
      if (!days.length) { html += noDataBox(i); continue; }
      const [entries, trainings] = await Promise.all([
        sbGet(`food_entries?day_id=eq.${days[0].id}&select=grams,foods(kcal_per_100g,carbs_per_100g,fat_per_100g)`),
        sbGet(`training_entries?day_id=eq.${days[0].id}&select=kcal`)
      ]);
      let fKcal=0, fCarbs=0, fFat=0;
      entries.forEach(e => {
        fKcal  += e.grams * e.foods.kcal_per_100g  / 100;
        fCarbs += e.grams * e.foods.carbs_per_100g / 100;
        fFat   += e.grams * e.foods.fat_per_100g   / 100;
      });
      const tk     = trainings.reduce((s,t)=>s+t.kcal,0);
      const nKcal  = Math.round(fKcal  - (days[0].bmr + tk));
      const nCarbs = Math.round(fCarbs - CARB_TARGET);
      const nFat   = Math.round(fFat   - FAT_TARGET);
      totalKcal += nKcal; totalCarbs += nCarbs; totalFat += nFat;
      const cls = nKcal>0?'positive':nKcal<0?'negative':'zero';
      html += `<div class="summary-box ${cls}"><h4>-${i}</h4>${nKcal} kcal<br>${nCarbs} hh<br>${nFat} r</div>`;
    } catch { html += noDataBox(i); }
  }

  html += `</div><br><strong>Yhteensä: ${totalKcal} kcal, ${totalCarbs} hh, ${totalFat} r</strong>`;
  document.getElementById('fiveDaySummary').innerHTML = html;
}

function noDataBox(i) {
  return `<div class="summary-box nodata"><h4>-${i}</h4>Ei dataa</div>`;
}

// =============================================
// CSV
// =============================================
async function downloadCSV() {
  setStatus('Haetaan...');
  try {
    const days = await sbGet('days?select=id,date,bmr&order=date.asc');
    let csv = 'Päivämäärä,Kalorit ruoasta,Hiilihydraatit,Rasva,Treenien kalorit,Perusaineenvaihdunta,Netto kcal,Netto hh,Netto r\n';
    for (const day of days) {
      const [entries, trainings] = await Promise.all([
        sbGet(`food_entries?day_id=eq.${day.id}&select=grams,foods(kcal_per_100g,carbs_per_100g,fat_per_100g)`),
        sbGet(`training_entries?day_id=eq.${day.id}&select=kcal`)
      ]);
      let fKcal=0, fCarbs=0, fFat=0;
      entries.forEach(e => {
        fKcal  += e.grams * e.foods.kcal_per_100g  / 100;
        fCarbs += e.grams * e.foods.carbs_per_100g / 100;
        fFat   += e.grams * e.foods.fat_per_100g   / 100;
      });
      const tk = trainings.reduce((s,t)=>s+t.kcal,0);
      csv += `${day.date},${Math.round(fKcal)},${Math.round(fCarbs)},${Math.round(fFat)},${tk},${day.bmr},${Math.round(fKcal-(day.bmr+tk))},${Math.round(fCarbs-CARB_TARGET)},${Math.round(fFat-FAT_TARGET)}\n`;
    }
    downloadBlob(csv, 'ruokaseuranta_backup.csv', 'text/csv;charset=utf-8;');
    setStatus('CSV ladattu ✓','ok');
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

// =============================================
// JSON export
// =============================================
async function exportJSON() {
  setStatus('Haetaan...');
  try {
    const days = await sbGet('days?select=*&order=date.asc');
    const out  = {};
    for (const day of days) {
      const [entries, trainings] = await Promise.all([
        sbGet(`food_entries?day_id=eq.${day.id}&select=*,foods(name)`),
        sbGet(`training_entries?day_id=eq.${day.id}&select=*`)
      ]);
      out[day.date] = {
        bmr:       day.bmr,
        foods:     entries.map(e => ({ name:e.foods.name, grams:e.grams, meal:e.meal, source:e.source })),
        trainings: trainings.map(t => ({ name:t.name, kcal:t.kcal }))
      };
    }
    downloadBlob(JSON.stringify(out,null,2), 'ruokaseuranta_backup.json', 'application/json');
    setStatus('JSON ladattu ✓','ok');
  } catch(e) { setStatus('Virhe: '+e.message,'error'); }
}

// =============================================
// JSON import
// =============================================
async function importJSON(e) {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  const data = JSON.parse(text);
  setStatus('Tuodaan dataa...');
  let count = 0;
  try {
    for (const [dateStr, day] of Object.entries(data)) {
      let existing = await sbGet(`days?date=eq.${dateStr}&select=id`);
      let dId;
      if (existing.length > 0) {
        dId = existing[0].id;
      } else {
        const result = await sbPost('days', { date:dateStr, bmr:day.bmr||BMR });
        dId = result[0].id;
      }
      for (const f of day.foods||[]) {
        const entry = Object.entries(foodsDB).find(([name]) => name === f.name);
        if (!entry) continue;
        await sbPost('food_entries', {
          day_id:f.food_id ? undefined : undefined, // placeholder
          ...{ day_id:dId, meal:f.meal, food_id:entry[1].id, grams:f.grams, source:f.source||'import' }
        });
      }
      for (const t of day.trainings||[]) {
        await sbPost('training_entries', { day_id:dId, name:t.name, kcal:t.kcal });
      }
      count++;
    }
    setStatus(`Tuotu ${count} päivää ✓`,'ok');
    await loadDay(document.getElementById('date').value);
  } catch(err) { setStatus('Tuontivirhe: '+err.message,'error'); }
  e.target.value = '';
}

function downloadBlob(content, filename, type) {
  const blob = new Blob([content], { type });
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// =============================================
// Päivän vaihto
// =============================================
document.getElementById('date').addEventListener('change', e => loadDay(e.target.value));

init();
</script>
</body>
</html>
